<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="shortcut icon" href="https://lixingyu.cn/star.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiFiNi Music List</title>
    <link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            margin: 0; /* ç§»é™¤è‡ªåŠ¨è¾¹è·ï¼Œä½¿å†…å®¹é å·¦ */
            padding: 20px;
            width: calc(100% - 500px); /* ä¸ºå³ä¾§æ’­æ”¾å™¨ç•™å‡ºç©ºé—´ */
            box-sizing: border-box;
            position: relative;
            float: left; /* æ·»åŠ æµ®åŠ¨ï¼Œç¡®ä¿å†…å®¹é å·¦ */
        }

        header {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .music-list {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            align-content: flex-start;
            gap: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .music-item {
            width: 160px; /* å›ºå®šå®½åº¦ */
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border-radius: 8px;
            border: 1px solid #f2f2f2;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            background: #fff;
            position: relative;
        }

        .music-item:hover {
            background: #f0f6ff;
        }

        .music-item.new-item {
            background: #e8f5e9; /* æ·¡ç»¿è‰²èƒŒæ™¯æ ‡è¯†æ–°åŠ è½½çš„æ•°æ® */
        }

        .music-item-action {
            position: absolute;
            top: 0;
            height: 100%;
            width: 50%;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.7);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .music-item-play {
            left: 0;
            border-radius: 8px 0 0 8px;
        }

        .music-item-add {
            right: 0;
            border-radius: 0 8px 8px 0;
        }

        .music-item:hover .music-item-action {
            opacity: 1;
        }

        .music-item-icon {
            font-size: 18px;
            color: #3498db;
        }

        .music-title {
            font-weight: 700;
            color: #222;
            font-size: 15px;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-author {
            color: #999;
            font-size: 12px;
            font-weight: 400;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading::after {
            content: "Loading...";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%,
            20% {
                content: "Loading.   ";
            }

            40% {
                content: "Loading..  ";
            }

            60% {
                content: "Loading... ";
            }

            80% {
                content: "Loading....";
            }

            100% {
                content: "Loading.....";
            }
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            display: none;
        }

        .status {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .page-btn {
            padding: 5px 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* ä¿®æ”¹ä¸ºå›ºå®šæ’­æ”¾å™¨æ ·å¼ */
        .player-container {
            position: fixed;
            right: 0;
            top: 0;
            width: 500px; /* å¢åŠ é»˜è®¤å®½åº¦ */
            z-index: 1000;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px 15px;
            box-sizing: border-box; /* ç¡®ä¿paddingä¸å¢åŠ æ€»å®½åº¦ */
            /* ç§»é™¤è¿™ä¸ªè¿‡æ¸¡æ•ˆæœï¼Œå®ƒä¼šå¯¼è‡´æ‹–æ‹½åå›åˆ°é»˜è®¤å®½åº¦ */
            /* transition: all 0.3s ease; */
        }

        .music-player {
            position: relative;
            width: 100%;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(52, 152, 219, 0.13);
            display: flex;
            flex-direction: column;
            padding: 24px;
            transition: all 0.3s ease;
            user-select: none;
            margin-bottom: 15px;
        }

        .player-header-draggable {
            display: flex;
            align-items: center;
            width: 100%;
            user-select: none;
            margin-bottom: 20px;
        }

        .music-player .player-cover {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            margin-right: 20px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .music-player .player-cover:hover {
            transform: scale(1.05);
        }

        .music-player .player-info {
            flex: 1;
            min-width: 0;
        }

        .music-player .player-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
            transition: color 0.2s;
        }

        .music-player:hover .player-title {
            color: #3498db;
        }

        .music-player .player-author {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-player .player-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .music-player .player-btn,
        .playlist-panel-wrap .player-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .music-player .player-btn:active,
        .playlist-panel-wrap .player-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.1);
        }

        .music-player .player-btn:hover,
        .playlist-panel-wrap .player-btn:hover {
            background: linear-gradient(145deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.25);
        }

        .music-player .player-progress {
            flex: 1;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            margin: 0 10px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .music-player .player-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .music-player .player-progress:hover {
            height: 8px;
            transition: height 0.2s ease;
        }

        .music-player .player-time {
            font-size: 13px;
            color: #7f8c8d;
            min-width: 70px;
            text-align: right;
            font-family: monospace;
        }

        .music-player .player-volume {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .music-player .player-volume-bar {
            width: 70px;
            height: 4px;
            background: #ecf0f1;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .music-player .player-volume-level {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 2px;
            transition: width 0.2s;
        }

        .music-player .player-volume-bar:hover {
            height: 6px;
            transition: height 0.2s ease;
        }

        /* æ–°å¢æ’­æ”¾åˆ—è¡¨æ ·å¼ */
        .playlist-panel-wrap {
            width: 100%;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.1);
            margin: 0 auto;
            overflow: hidden;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 18px;
            border-bottom: 1px solid #ecf0f1;
        }

        .playlist-btn {
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 13px;
            padding: 5px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .playlist-btn:hover {
            background: #f5f5f5;
            color: #e74c3c;
        }

        .playlist-btn svg {
            width: 14px;
            height: 14px;
        }

        .playlist-panel {
            margin-top: 0;
            padding: 8px 18px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .playlist-panel::-webkit-scrollbar {
            width: 6px;
        }

        .playlist-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .playlist-panel::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        .playlist-panel::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        .playlist-item {
            padding: 12px 15px;
            font-size: 15px;
            color: #333;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-bottom: 2px;
            position: relative;
            overflow: hidden;
        }

        .playlist-item-delete {
            opacity: 0;
            margin-left: 8px;
            cursor: pointer;
            color: #bdc3c7;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .playlist-item:hover .playlist-item-delete {
            opacity: 1;
        }

        .playlist-item-delete:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .playlist-item.active {
            background: #eaf3ff;
            color: #3498db;
            font-weight: 700;
        }

        .playlist-item.active::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #3498db;
            border-radius: 0 2px 2px 0;
        }

        .playlist-item:hover {
            background: #f5f9ff;
            transform: translateX(4px);
        }

        .playlist-item .playlist-artist {
            color: #95a5a6;
            font-size: 13px;
            font-weight: 400;
            margin-left: auto;
        }

        /* åŠ è½½æ›´å¤šæŒ‰é’®æ ·å¼ */
        .load-more-btn {
            display: flex;
            margin: 20px auto;
            padding: 12px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .load-more-btn:hover {
            background: #217dbb;
        }

        .load-more-btn:active {
            transform: scale(0.98);
        }

        .load-more-btn .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .load-more-btn.loading .loading-spinner {
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æ»šåŠ¨åŠ è½½æŒ‡ç¤ºå™¨ */
        .scroll-loader {
            text-align: center;
            padding: 15px;
            display: none;
        }

        .scroll-loader::after {
            content: "åŠ è½½ä¸­...";
            animation: dots 1.5s steps(5, end) infinite;
        }

        /* Cookieè®¾ç½®å¯¹è¯æ¡†æ ·å¼ */
        .cookie-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .cookie-modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .cookie-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cookie-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .cookie-textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            font-family: monospace;
            resize: vertical;
        }

        .cookie-result {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            display: none;
        }

        .cookie-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            padding: 5px 10px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .settings-btn:hover {
            background-color: #e0e0e0;
        }

        .settings-icon {
            font-size: 16px;
        }

        /* æŒ‰é’®ç»„æ ·å¼ */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .search-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            background-color: #2980b9;
        }

        .search-btn .search-icon {
            font-size: 18px;
        }

        .search-btn .shortcut {
            font-size: 12px;
            opacity: 0.8;
            margin-left: 4px;
        }

        /* ä¿®æ”¹åˆ†éš”æ¡æ ·å¼ */
        .resizer {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 10px;
            background-color: transparent;
            cursor: col-resize;
            z-index: 1500;
            transition: background-color 0.2s;
            right: 500px; /* é»˜è®¤ä½ç½®åœ¨æ’­æ”¾å™¨å·¦ä¾§ */
        }

        .resizer:hover, .resizer.active {
            background-color: rgba(52, 152, 219, 0.2);
        }

        .resizer-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            color: #3498db;
            font-size: 13px;
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
        }

        .resizer:hover .resizer-tip, .resizer.active .resizer-tip {
            opacity: 1;
            color: #1766a3;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 0 20px;
        }

        #searchInput {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        #searchButton {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #searchButton:hover {
            background-color: #0056b3;
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .search-modal-content {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2001;
        }

        .search-modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #searchInput {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 90%;
            max-width: 500px;
            transition: all 0.3s ease;
        }

        #searchInput:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .search-results {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 2px;
        }

        .search-result-item {
            display: flex;
            cursor: pointer;
            padding: 0;
            border-bottom: 1px solid #eee;
            position: relative;
            transition: all 0.2s;
        }

        .search-result-play-area {
            flex: 1;
            padding: 12px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-add-area {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            width: 60px;
            border-left: 1px solid #eee;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f9f9f9;
        }

        .search-result-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 50%;
            height: 100%;
            cursor: pointer;
            z-index: 0;
        }

        .search-result-item::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 50%;
            height: 100%;
            cursor: pointer;
            z-index: 0;
        }

        .search-result-action {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f0f0f0;
        }

        .search-result-action:hover {
            background: #e0e0e0;
        }

        .search-result-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 14px;
        }

        .search-result-info {
            width: 50%;
            overflow: hidden;
        }

        .search-result-title {
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-author {
            color: #666;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-error, .search-loading, .search-no-results {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .search-error {
            color: #ff4444;
        }

        /* æœç´¢åˆ†é¡µæ ·å¼ */
        .search-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        .search-page-btn {
            padding: 6px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .search-page-btn:hover {
            background-color: #2980b9;
        }

        .search-page-info {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>

<body>
<div class="container">
    <header>
        <h1>HiFiNi Music List</h1>
        <div class="header-actions">
            <div class="controls">
                <button class="btn" id="refreshBtn">è·å–æ–°æ•°æ®</button>
                <button class="btn" id="cookieSettingsBtn">
                    <span class="settings-icon">âš™ï¸</span>è®¾ç½®Cookie
                </button>
                <button class="search-btn" id="searchBtn">
                    <span class="search-icon">ğŸ”</span>æœç´¢éŸ³ä¹
                    <span class="shortcut">(S)</span>
                </button>
            </div>
        </div>
        <div class="status" id="status"></div>
    </header>

    <div class="loading"></div>
    <div class="error"></div>
    <div class="music-list" id="musicList"></div>
    <div class="scroll-loader" id="scrollLoader"></div>

    <!-- æ·»åŠ ç»“æœå®¹å™¨ -->
    <div id="resultContainer" style="display:none;">
        <div id="resultContent"></div>
    </div>
</div>

<!-- åˆ†éš”æ¡ -->
<div class="resizer" id="resizer"><span class="resizer-tip">â‡† æ‹–åŠ¨è°ƒæ•´å®½åº¦</span></div>

<!-- å›ºå®šå³ä¾§æ’­æ”¾å™¨ -->
<div class="player-container" id="playerContainer">
    <div class="music-player" id="musicPlayer"></div>
    <div class="playlist-panel-wrap" id="playlistPanel"></div>
</div>

<!-- Cookieè®¾ç½®å¯¹è¯æ¡† -->
<div class="cookie-modal" id="cookieModal">
    <div class="cookie-modal-content">
        <div class="cookie-modal-header">
            <h3>è®¾ç½®Cookie</h3>
            <button class="cookie-modal-close" id="closeCookieModal">&times;</button>
        </div>
        <div id="cookieInfo"></div>
        <p>è¯·ç²˜è´´Hifiniçš„Cookie JSONæ•°æ®:</p>
        <textarea class="cookie-textarea" id="cookieInput"
                  placeholder='[{"domain": "www.hifini.com", "name": "bbs_sid", "value": "xxx"}, ...]'></textarea>
        <div class="cookie-result" id="cookieResult"></div>
        <div class="cookie-actions">
            <button class="btn" id="parseCookieBtn">è§£æCookie</button>
            <button class="btn" id="saveCookieBtn">ä¿å­˜åˆ°æœåŠ¡å™¨</button>
        </div>
    </div>
</div>

<!-- åœ¨bodyæ ‡ç­¾å†…çš„é€‚å½“ä½ç½®æ·»åŠ  -->
<div id="searchModal" class="search-modal">
    <div class="search-modal-content">
        <div class="search-modal-header">
            <input type="text" id="searchInput" placeholder="æœç´¢éŸ³ä¹..."/>
        </div>
        <div id="searchResults" class="search-results"></div>
    </div>
</div>

<script>
    let currentPage = 1;
    let allMusicData = [];
    let currentMusicInfo = null;
    let playList = [];
    let playIndex = -1;
    let playMode = 'order'; // 'order', 'random', or 'random-no-repeat'
    let isLoadingMore = false; // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®
    let hasMoreData = true; // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    // New: History for random playback
    let playHistory = [];
    const MAX_HISTORY_SIZE = 5; // Keep track of the last 5 played songs
    // è®¾ç½®éœ€è¦æ’é™¤çš„çº¿ç¨‹IDåˆ—è¡¨
    const excludedThreadIds = ['6', '1575', '16216'];
    let playedSongs = new Set(); // Track played songs for random-no-repeat mode

    // Base32 ç¼–ç å‡½æ•°
    function base32Encode(str) {
        var base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
        var bits = "";
        var base32 = "";

        for (var i = 0; i < str.length; i++) {
            var bit = str.charCodeAt(i).toString(2);
            while (bit.length < 8) {
                bit = "0" + bit;
            }
            bits += bit;
        }

        while (bits.length % 5 !== 0) {
            bits += "0";
        }

        for (var i = 0; i < bits.length; i += 5) {
            var chunk = bits.substring(i, i + 5);
            base32 += base32chars[parseInt(chunk, 2)];
        }

        while (base32.length % 8 !== 0) {
            base32 += "=";
        }

        return base32.replace(/=/g, 'HiFiNiYINYUECICHANG');
    }

    // ç½‘é¡µä¸Šçš„ generateParam å‡½æ•°
    function generateParam(data) {
        var key = '95wwwHiFiNicom27';
        var outText = '';

        for (var i = 0, j = 0; i < data.length; i++, j++) {
            if (j == key.length) j = 0;
            outText += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(j));
        }
        return base32Encode(outText);
    }

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
    }

    function displayMusicList(data, append = false, isNewData = false) {
        const musicList = document.getElementById('musicList');

        if (!append) {
            musicList.innerHTML = '';
        }

        // è®¡ç®—éœ€è¦å¤šå°‘åˆ—ï¼ˆä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³æ’åˆ—ï¼‰
        const numRows = 10;
        const numCols = Math.ceil(data.length / numRows);

        // åˆ›å»ºä¸€ä¸ªäºŒç»´æ•°ç»„ç”¨äºé‡æ’æ•°æ®
        let reorderedData = [];
        for (let col = 0; col < numCols; col++) {
            for (let row = 0; row < numRows; row++) {
                const index = col * numRows + row;
                if (index < data.length) {
                    reorderedData.push(data[index]);
                }
            }
        }

        reorderedData.forEach(item => {
            const musicInfo = parseMusicInfo(item.title);
            const musicItem = document.createElement('div');
            musicItem.className = 'music-item';
            // å¦‚æœæ˜¯æ–°åŠ è½½çš„æ•°æ®ï¼Œæ·»åŠ æ–°æ•°æ®æ ·å¼
            if (isNewData) {
                musicItem.classList.add('new-item');
            }

            // åˆ›å»ºåŸºæœ¬ä¿¡æ¯å±•ç¤º
            musicItem.innerHTML = `
          <div class="music-title">${musicInfo.title}</div>
          <div class="music-author">${musicInfo.artist}</div>
          <div class="music-item-action music-item-play">
            <span class="music-item-icon">â–¶ï¸</span>
          </div>
          <div class="music-item-action music-item-add">
            <span class="music-item-icon">+</span>
          </div>
        `;

            // ç§»é™¤æ•´ä½“ç‚¹å‡»äº‹ä»¶ï¼Œæ”¹ä¸ºå·¦å³ä¸¤ä¾§å•ç‹¬ç‚¹å‡»äº‹ä»¶
            const playAction = musicItem.querySelector('.music-item-play');
            const addAction = musicItem.querySelector('.music-item-add');

            // ç«‹å³æ’­æ”¾
            playAction.onclick = (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                item.parsedTitle = musicInfo.title;
                item.parsedArtist = musicInfo.artist;

                // æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨çš„ç¬¬ä¸€è¡Œå¹¶ç«‹å³æ’­æ”¾
                playList = playList.filter(s => s.threadId !== item.threadId); // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç›¸åŒæ­Œæ›²
                playList.unshift({  // ä½¿ç”¨unshiftæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                    ...item,
                    musicInfo: musicInfo
                });
                playIndex = 0;  // è®¾ç½®ä¸ºç¬¬ä¸€é¦–æ­Œæ›²
                fetchThreadContentAndPlay(playList[playIndex]);
            };

            // ä»…æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
            addAction.onclick = (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                item.parsedTitle = musicInfo.title;
                item.parsedArtist = musicInfo.artist;

                // åŠ å…¥æ’­æ”¾åˆ—è¡¨
                addToPlayList({
                    ...item,
                    musicInfo: musicInfo
                });
            };

            musicList.appendChild(musicItem);
        });
    }

    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => goToPage(i);
            pagination.appendChild(pageBtn);
        }
    }

    function goToPage(page) {
        currentPage = page;
        const start = (page - 1) * 20;
        const end = start + 20;
        displayMusicList(allMusicData.slice(start, end));
        updatePagination();
    }

    // è§£æéŸ³ä¹æ ‡é¢˜å’Œæ­Œæ‰‹
    function parseMusicInfo(title) {
        // åªå–ç¬¬ä¸€ä¸ªã€Šã€‹é‡Œçš„å†…å®¹ä¸ºtitleï¼Œå‰é¢ä¸ºartistï¼Œåé¢å¿½ç•¥
        const match = title.match(/^(.*?)ã€Š([^ã€‹]+)ã€‹/);
        if (match) {
            return {
                artist: match[1].replace(/\[.*?\]/g, '').trim(),
                title: match[2].trim()
            };
        }
        return {
            artist: '',
            title: title.trim()
        };
    }

    // æ˜¾ç¤ºéŸ³ä¹è¯¦æƒ…çš„å‡½æ•°
    function displayMusicDetail(detail, autoplay = true) {
        let musicUrl = detail.musicUrl;

        // New: Get saved volume from localStorage
        const savedVolume = parseFloat(localStorage.getItem('musicVolume') || '1.0');

        // æ–°å¢ï¼šå¦‚æœrawKeyä»¥.m4aç»“å°¾ï¼Œfetchå¹¶å¸¦headers
        if (detail.rawKey && typeof detail.rawKey === 'string' && detail.rawKey.endsWith('.m4a')) {
            // è·å–æ’­æ”¾å™¨å®¹å™¨
            const playerContainer = document.getElementById('playerContainer');
            const musicPlayer = document.getElementById('musicPlayer');
            const playlistPanel = document.getElementById('playlistPanel');
            playerContainer.style.display = 'flex';
            if (musicPlayer.audio) musicPlayer.audio.pause();

            // æå‰ä¿å­˜å°é¢å›¾ç‰‡URL (ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„coverImage)
            const coverImageUrl = detail.coverImage || 'https://lixingyu.cn/star.ico';

            // æ˜¾ç¤ºåŠ è½½ä¸­ï¼ŒåŒæ—¶æ˜¾ç¤ºå°é¢
            musicPlayer.innerHTML = `
        <div class="player-header-draggable">
          <img src="${coverImageUrl}" class="player-cover"/>
          <div class="player-info">
            <div class="player-title">${currentMusicInfo?.title || 'åŠ è½½ä¸­...'}</div>
            <div class="player-author">${currentMusicInfo?.artist || 'æ­£åœ¨è·å–éŸ³é¢‘...'}</div>
          </div>
        </div>
        <div style='text-align:center;padding:20px;color:#3498db;'>
          <div>éŸ³é¢‘åŠ è½½ä¸­...</div>
        </div>`;

            // é€šè¿‡åç«¯ä»£ç†è¯·æ±‚éŸ³é¢‘
            const proxyUrl = `/api/proxyAudio?url=${encodeURIComponent(detail.rawKey)}`;
            console.log('ä»£ç†è¯·æ±‚m4aéŸ³é¢‘:', detail.rawKey);

            fetch(proxyUrl, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) throw new Error('éŸ³é¢‘è·å–å¤±è´¥: ' + response.status);
                    return response.blob();
                })
                .then(blob => {
                    console.log('éŸ³é¢‘è·å–æˆåŠŸ, å¤§å°:', Math.round(blob.size / 1024), 'KB');
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    musicPlayer.audio = audio;

                    // å°†éŸ³é¢‘ä¿¡æ¯ä¿å­˜åˆ°æ’­æ”¾å™¨å…ƒç´ ï¼Œä¾›é¡µé¢å…³é—­æ—¶ä¿å­˜
                    musicPlayer.dataset.musicUrl = detail.musicUrl || '';
                    musicPlayer.dataset.rawKey = detail.rawKey || '';
                    musicPlayer.dataset.generateParamString = '';

                    const showTitle = (currentMusicInfo && currentMusicInfo.title) ? currentMusicInfo.title : '';
                    const showArtist = (currentMusicInfo && currentMusicInfo.artist) ? currentMusicInfo.artist : '';

                    musicPlayer.innerHTML = `
            <div class="player-header-draggable">
              <img src="${coverImageUrl}" class="player-cover"/>
              <div class="player-info">
                <div class="player-title">${showTitle}</div>
                <div class="player-author">${showArtist}</div>
              </div>
            </div>
            <div class="player-controls">
              <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
              <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
              <div class="player-time">0:00 / 0:00</div>
              <div class="player-volume">
                <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${audio.muted ? svgMute : svgVolume}</span></button>
                <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:${audio.volume * 100}%"></div></div>
              </div>
            </div>
          `;
                    const playBtn = musicPlayer.querySelector('.player-btn.play');
                    const playIcon = playBtn.querySelector('.play-icon');
                    const progressBar = musicPlayer.querySelector('.player-progress-bar');
                    const timeDisplay = musicPlayer.querySelector('.player-time');
                    const volumeBar = musicPlayer.querySelector('.player-volume-level');
                    audio.addEventListener('play', () => {
                        playIcon.innerHTML = svgPause;
                    });
                    audio.addEventListener('pause', () => {
                        playIcon.innerHTML = svgPlay;
                    });
                    audio.addEventListener('timeupdate', () => {
                        const progress = (audio.currentTime / audio.duration) * 100;
                        progressBar.style.width = `${progress}%`;
                        timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;

                        // æ¯ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
                        if (Math.floor(audio.currentTime) % 5 === 0) { // æ¯5ç§’ä¿å­˜ä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šå†™å…¥
                            savePlaybackState(detail, audio.currentTime);
                        }
                    });
                    audio.addEventListener('volumechange', () => {
                        volumeBar.style.width = `${audio.volume * 100}%`;
                    });
                    audio.addEventListener('ended', () => {
                        playNext({
                            stopPropagation: () => {
                            }
                        });
                    });
                    if (autoplay) {
                        audio.play().catch((e) => {
                            console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                        });
                    }
                    setTimeout(() => {
                        renderPlayList();
                    }, 100);
                })
                .catch(err => {
                    console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', err);
                    musicPlayer.innerHTML = `
          <div class="player-header-draggable">
            <img src="${coverImageUrl}" class="player-cover"/>
            <div class="player-info">
              <div class="player-title">${currentMusicInfo?.title || 'åŠ è½½å¤±è´¥'}</div>
              <div class="player-author">${currentMusicInfo?.artist || 'æ— æ³•æ’­æ”¾'}</div>
            </div>
          </div>
          <div style='color:red;padding:20px;text-align:center;'>
            <div>éŸ³é¢‘åŠ è½½å¤±è´¥: ${err.message}</div>
            <button onclick="fetchThreadContentAndPlay(playList[playIndex])"
              style="margin-top:10px;padding:5px 10px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer">
              é‡è¯•
            </button>
          </div>`;
                });
            return;
        }
        if (detail.rawKey && detail.generateParamString) {
            const newP = generateParam(detail.generateParamString);
            musicUrl += `?key=${detail.rawKey}&p=${newP}`;
            const audio = new Audio(musicUrl);

            // è·å–å›ºå®šçš„æ’­æ”¾å™¨å®¹å™¨
            const playerContainer = document.getElementById('playerContainer');
            const musicPlayer = document.getElementById('musicPlayer');
            const playlistPanel = document.getElementById('playlistPanel');

            // æ˜¾ç¤ºæ’­æ”¾å™¨å®¹å™¨
            playerContainer.style.display = 'flex';

            if (musicPlayer.audio) musicPlayer.audio.pause();
            musicPlayer.audio = audio;

            // å°†éŸ³é¢‘ä¿¡æ¯ä¿å­˜åˆ°æ’­æ”¾å™¨å…ƒç´ ï¼Œä¾›é¡µé¢å…³é—­æ—¶ä¿å­˜
            musicPlayer.dataset.musicUrl = detail.musicUrl || '';
            musicPlayer.dataset.rawKey = detail.rawKey || '';
            musicPlayer.dataset.generateParamString = detail.generateParamString || '';

            const showTitle = (currentMusicInfo && currentMusicInfo.title) ? currentMusicInfo.title : '';
            const showArtist = (currentMusicInfo && currentMusicInfo.artist) ? currentMusicInfo.artist : '';

            musicPlayer.innerHTML = `
          <div class="player-header-draggable">
            <img src="${detail.coverImage || 'https://lixingyu.cn/star.ico'}" class="player-cover"/>
            <div class="player-info">
              <div class="player-title">${showTitle}</div>
              <div class="player-author">${showArtist}</div>
            </div>
          </div>
          <div class="player-controls">
            <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
            <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
            <div class="player-time">0:00 / 0:00</div>
            <div class="player-volume">
              <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${audio.muted ? svgMute : svgVolume}</span></button>
              <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:${audio.volume * 100}%"></div></div>
            </div>
          </div>
        `;

            const playBtn = musicPlayer.querySelector('.player-btn.play');
            const playIcon = playBtn.querySelector('.play-icon');
            const progressBar = musicPlayer.querySelector('.player-progress-bar');
            const timeDisplay = musicPlayer.querySelector('.player-time');
            const volumeBar = musicPlayer.querySelector('.player-volume-level');

            audio.addEventListener('play', () => {
                playIcon.innerHTML = svgPause;
            });
            audio.addEventListener('pause', () => {
                playIcon.innerHTML = svgPlay;
            });
            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${progress}%`;
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;

                // æ¯5ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
                if (Math.floor(audio.currentTime) % 5 === 0) {
                    savePlaybackState(detail, audio.currentTime);
                }
            });
            audio.addEventListener('volumechange', () => {
                volumeBar.style.width = `${audio.volume * 100}%`;
            });
            // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
            audio.addEventListener('ended', () => {
                playNext({
                    stopPropagation: () => {
                    }
                });
            });

            if (autoplay) {
                audio.play().catch(() => {
                });
            }
            setTimeout(() => {
                renderPlayList();
            }, 100);
        } else {
            const resultContent = document.getElementById('resultContent');
            if (resultContent) {
                resultContent.innerHTML = `
            <div class="music-player">
              <div class="player-header">
                <div class="player-info">
                  <div class="player-title">${detail.title}</div>
                  <div class="player-author">${detail.author || 'æœªçŸ¥ä½œè€…'}</div>
                </div>
              </div>
              ${detail.lyrics ? `
                <div class="lyrics-container">
                  ${detail.lyrics.split('\n').map(line => `
                    <div class="lyrics-line">${line}</div>
                  `).join('')}
                </div>
              ` : ''}
              <div style="margin-top: 20px;">
                <strong>ä¸‹è½½é“¾æ¥:</strong><br>
                ${detail.downloadLinks.map(link => `
                  <a href="${link}" target="_blank" style="color: #3498db; text-decoration: none;">${link}</a><br>
                `).join('')}
              </div>
            </div>
          `;
                document.getElementById('resultContainer').style.display = 'block';
            }
        }
    }

    // ç§»é™¤ä¸éœ€è¦çš„æµ®åŠ¨æ’­æ”¾å™¨å‡½æ•°
    function closeFloatingPlayer(e) {
        const musicPlayer = document.getElementById('musicPlayer');
        if (musicPlayer && musicPlayer.audio) musicPlayer.audio.pause();
        document.getElementById('playerContainer').style.display = 'none';
    }

    // ä¸å†éœ€è¦ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ’­æ”¾å™¨
    function floatingPlayerClickAway(e) {
        // æ­¤å‡½æ•°ä¿ç•™ä½†ä¸å†ä½¿ç”¨
    }

    // æ’­æ”¾æ§åˆ¶å‡½æ•°
    function togglePlay(button) {
        const player = document.querySelector('.music-player');
        const audio = player.audio;
        const icon = button.querySelector('.play-icon');

        if (audio.paused) {
            audio.play();
            icon.innerHTML = svgPause;
        } else {
            audio.pause();
            icon.innerHTML = svgPlay;
        }
    }

    function seek(event) {
        const player = document.querySelector('.music-player');
        const audio = player.audio;
        const progressBar = event.currentTarget;
        const rect = progressBar.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const percentage = x / rect.width;
        audio.currentTime = audio.duration * percentage;
    }

    function toggleMute(button) {
        const player = document.querySelector('.music-player');
        const audio = player.audio;
        const icon = button.querySelector('.volume-icon');

        if (audio.muted) {
            audio.muted = false;
            icon.innerHTML = svgVolume;
        } else {
            audio.muted = true;
            icon.innerHTML = svgMute;
        }
    }

    function setVolume(event) {
        const player = document.querySelector('.music-player');
        const audio = player.audio;
        const volumeBar = event.currentTarget;
        const rect = volumeBar.getBoundingClientRect();
        const x = event.clientX - rect.left;
        audio.volume = x / rect.width;
        // New: Save volume to localStorage explicitly on change
        localStorage.setItem('musicVolume', audio.volume);
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // è·å–çº¿ç¨‹å†…å®¹çš„å‡½æ•°
    async function fetchThreadContent(threadId) {
        try {
            updateStatus(`æ­£åœ¨è·å–çº¿ç¨‹ ${threadId} çš„å†…å®¹...`);

            const response = await fetch(`/music/${threadId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const detail = await response.json();
            displayMusicDetail(detail);
            updateStatus(`å·²è·å–çº¿ç¨‹ ${threadId} çš„å†…å®¹`);
        } catch (error) {
            console.error('Error fetching thread content:', error);
            updateStatus(`è·å–çº¿ç¨‹ ${threadId} å¤±è´¥: ${error.message}`);

            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<span style="color: red;">è·å–å¤±è´¥: ${error.message}</span>`;
            document.getElementById('resultContainer').style.display = 'block';
        }
    }

    async function fetchPage(page) {
        const response = await fetch(`/api/songs?page=${page}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return await response.json();
    }

    // æ–°å¢ï¼šå…¨å±€å»é‡å‡½æ•°
    function removeDuplicates(array, idField = 'threadId') {
        const seen = new Set();
        return array.filter(item => {
            const id = item[idField];
            if (seen.has(id)) {
                return false;
            }
            seen.add(id);
            return true;
        });
    }

    // è¿‡æ»¤æ‰æ’é™¤çš„çº¿ç¨‹ID
    function filterExcludedThreads(data) {
        return data.filter(item => !excludedThreadIds.includes(item.threadId));
    }

    // è·å–å·²åŠ è½½æ­Œæ›²çš„IDé›†åˆ
    function getExistingIds() {
        return new Set(allMusicData.map(item => item.threadId));
    }

    // æ£€æŸ¥CookieçŠ¶æ€çš„å‡½æ•°
    async function checkCookieStatus() {
        try {
            const response = await fetch('/api/cookieStatus');
            if (!response.ok) {
                throw new Error('è·å–CookieçŠ¶æ€å¤±è´¥');
            }

            const status = await response.json();

            if (status.needsUpdate) {
                // æ˜¾ç¤ºCookieè®¾ç½®å¯¹è¯æ¡†
                showCookieModal(true);
                updateStatus('æ‚¨çš„Cookieå·²è¿‡æœŸæˆ–æœªè®¾ç½®ï¼Œè¯·æ›´æ–°Cookie');
                return false;
            }

            return true;
        } catch (error) {
            console.error('æ£€æŸ¥CookieçŠ¶æ€å‡ºé”™:', error);
            updateStatus('æ£€æŸ¥CookieçŠ¶æ€å‡ºé”™: ' + error.message);
            return false;
        }
    }

    // æ˜¾ç¤ºæˆ–éšè—Cookieè®¾ç½®å¯¹è¯æ¡†
    function showCookieModal(forced = false) {
        const cookieModal = document.getElementById('cookieModal');
        cookieModal.style.display = 'flex';

        // å¦‚æœæ˜¯å¼ºåˆ¶æ›´æ–°ï¼Œæ·»åŠ æç¤ºä¿¡æ¯
        if (forced) {
            const cookieInfoEl = document.getElementById('cookieInfo');
            if (cookieInfoEl) {
                cookieInfoEl.innerHTML = '<div style="color: #e74c3c; margin-bottom: 10px; font-weight: bold;">âš ï¸ Cookieå·²è¿‡æœŸæˆ–æœªè®¾ç½®ï¼Œè¯·æ›´æ–°åæ‰èƒ½ç»§ç»­ä½¿ç”¨</div>';
            }

            // ç¦ç”¨å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('closeCookieModal');
            if (closeBtn) {
                closeBtn.style.display = 'none';
            }

            // é˜»æ­¢ç‚¹å‡»å¤–éƒ¨å…³é—­
            cookieModal.dataset.forced = 'true';
        } else {
            // æ¢å¤å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('closeCookieModal');
            if (closeBtn) {
                closeBtn.style.display = 'block';
            }

            // å…è®¸æ­£å¸¸å…³é—­
            cookieModal.dataset.forced = 'false';

            // æ¸…é™¤æç¤ºä¿¡æ¯
            const cookieInfoEl = document.getElementById('cookieInfo');
            if (cookieInfoEl) {
                cookieInfoEl.innerHTML = '';
            }
        }
    }

    async function loadMoreData() {
        if (isLoadingMore || !hasMoreData) return;

        // æ£€æŸ¥CookieçŠ¶æ€
        const cookieValid = await checkCookieStatus();
        if (!cookieValid) {
            return; // å¦‚æœCookieæ— æ•ˆï¼Œåœæ­¢åŠ è½½
        }

        isLoadingMore = true;
        const scrollLoader = document.getElementById('scrollLoader');
        scrollLoader.style.display = 'block';

        try {
            updateStatus(`æ­£åœ¨åŠ è½½æ›´å¤šæ­Œæ›²...`);
            const pageData = await fetchPage(currentPage);

            // è¿‡æ»¤æ‰æ’é™¤çš„çº¿ç¨‹ID
            const filteredData = filterExcludedThreads(pageData);

            // è¿‡æ»¤é‡å¤æ•°æ®
            const existingIds = getExistingIds();
            const newData = filteredData.filter(item => !existingIds.has(item.threadId));

            if (newData.length === 0) {
                hasMoreData = false;
                updateStatus(`æ²¡æœ‰æ›´å¤šæ­Œæ›²äº†`);
                scrollLoader.style.display = 'none';
                return;
            }

            // åˆå¹¶å»é‡åçš„æ•°æ®
            allMusicData = [...allMusicData, ...newData];
            displayMusicList(newData, true);
            currentPage++;

            updateStatus(`å·²åŠ è½½ ${allMusicData.length} é¦–æ­Œæ›²`);
        } catch (err) {
            const error = document.querySelector('.error');
            error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
            error.style.display = 'block';
            hasMoreData = false; // å‡ºé”™æ—¶åœæ­¢åŠ è½½
        } finally {
            isLoadingMore = false;
            scrollLoader.style.display = 'none';
        }
    }

    // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬
    function setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
            if (isLoadingMore || !hasMoreData) return;

            const scrollY = window.scrollY;
            const visibleHeight = window.innerHeight;
            const pageHeight = document.documentElement.scrollHeight;
            const bottomOfPage = visibleHeight + scrollY >= pageHeight - 300;

            if (bottomOfPage) {
                loadMoreData();
            }
        });
    }

    // æ–°å¢ï¼šåŠ å…¥æ’­æ”¾åˆ—è¡¨
    function addToPlayList(song) {
        // æ£€æŸ¥æ˜¯å¦å·²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ï¼ˆå¯æ ¹æ® threadId å”¯ä¸€æ€§ï¼‰
        const exists = playList.findIndex(s => s.threadId === song.threadId);
        if (exists === -1) {
            // æ–°æ­Œæ’å…¥åˆ°å½“å‰æ’­æ”¾æ­Œæ›²åé¢
            if (playIndex >= 0 && playIndex < playList.length - 1) {
                playList.splice(playIndex + 1, 0, song);
            } else {
                playList.push(song);
            }
        }
        // å¦‚æœæ²¡æœ‰æ­£åœ¨æ’­æ”¾ï¼Œåˆ™ç«‹å³æ’­æ”¾
        if (playIndex === -1) {
            playIndex = playList.length - 1;
            fetchThreadContentAndPlay(playList[playIndex]);
        }
        renderPlayList();
    }

    // ä¿®æ”¹æ¸²æŸ“æ’­æ”¾åˆ—è¡¨å‡½æ•°
    function renderPlayList() {
        const playlistPanel = document.getElementById('playlistPanel');
        if (!playlistPanel) return;

        // å…ˆæ¸²æŸ“æ§åˆ¶æŒ‰é’®
        let listHtml = `<div class="playlist-controls">`;
        let modeIcon = svgOrder;
        if (playMode === 'random') {
            modeIcon = svgShuffle;
        } else if (playMode === 'random-no-repeat') {
            modeIcon = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 4L16 16M16 4L4 16" stroke="#fff" stroke-width="2"/>
                <circle cx="10" cy="10" r="8" stroke="#fff" stroke-width="2" fill="none"/>
            </svg>`;
        }
        listHtml += `<button class='player-btn mode-btn' onclick='togglePlayMode(event)' title='${playMode === 'order' ? 'é¡ºåºæ’­æ”¾' : playMode === 'random' ? 'éšæœºæ’­æ”¾' : 'ä¸é‡å¤éšæœºæ’­æ”¾'}' style='font-size:16px;'>${modeIcon}</button>`;
        listHtml += `<button class='player-btn prev-btn' onclick='playPrev(event)' title='ä¸Šä¸€é¦–' style='font-size:16px;'>${svgPrev}</button>`;
        listHtml += `<button class='player-btn next-btn' onclick='playNext(event)' title='ä¸‹ä¸€é¦–' style='font-size:16px;'>${svgNext}</button>`;

        // æ·»åŠ æ¸…ç©ºåˆ—è¡¨æŒ‰é’®
        if (playList.length > 1) {
            listHtml += `<button class='playlist-btn' onclick='clearPlayList(event)' title='æ¸…ç©ºæ’­æ”¾åˆ—è¡¨'>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          æ¸…ç©ºåˆ—è¡¨
        </button>`;
        }

        listHtml += `<div style="margin-left:auto;font-size:14px;color:#7f8c8d;">${playList.length} é¦–æ­Œæ›²</div>`;
        listHtml += `</div>`;

        // å†æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        listHtml += '<div class="playlist-panel">';
        if (playList.length === 0) {
            listHtml += `<div style="text-align:center;padding:20px;color:#95a5a6;font-size:14px;">æ’­æ”¾åˆ—è¡¨ä¸ºç©º<br>ç‚¹å‡»æ­Œæ›²å¡ç‰‡ä¸Šçš„ + æ·»åŠ æ­Œæ›²</div>`;
        } else {
            playList.forEach((song, idx) => {
                const isCurrentPlaying = idx === playIndex;

                // ç¡®ä¿æ­Œæ›²ä¿¡æ¯å®Œæ•´ (ä»musicInfoæˆ–parsedTitle/Artistè·å–å®Œæ•´ä¿¡æ¯)
                const title = song.musicInfo?.title || song.parsedTitle || 'æœªçŸ¥æ­Œæ›²';
                const artist = song.musicInfo?.artist || song.parsedArtist || 'æœªçŸ¥è‰ºæœ¯å®¶';

                // æ›´æ–°æ­Œæ›²ä¿¡æ¯å¯¹è±¡ä»¥ç¡®ä¿å®Œæ•´æ€§
                if (!song.musicInfo) {
                    song.musicInfo = {title, artist};
                } else {
                    if (!song.musicInfo.title) song.musicInfo.title = title;
                    if (!song.musicInfo.artist) song.musicInfo.artist = artist;
                }

                // åŒæ—¶æ›´æ–°parsedå±æ€§ä»¥ä¿æŒä¸€è‡´æ€§
                song.parsedTitle = title;
                song.parsedArtist = artist;

                listHtml += `<div class="playlist-item${isCurrentPlaying ? ' active' : ''}" onclick="playFromList(${idx})">
            <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;">${title}</span>
            <span class='playlist-artist'>${artist}</span>
            ${!isCurrentPlaying ?
                    `<span class="playlist-item-delete" onclick="removeFromPlayList(${idx}, event)" title="ä»åˆ—è¡¨ä¸­ç§»é™¤">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </span>`
                    : ''}
          </div>`;
            });
        }
        listHtml += '</div>';

        playlistPanel.innerHTML = listHtml;

        // ä¿å­˜æ’­æ”¾åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('playList', JSON.stringify(playList));
        localStorage.setItem('playIndex', playIndex.toString());
    }

    // æ–°å¢ï¼šåˆ‡æ¢æ’­æ”¾æ¨¡å¼
    function togglePlayMode(e) {
        e.stopPropagation();
        // å¾ªç¯åˆ‡æ¢ä¸‰ç§æ¨¡å¼ï¼šé¡ºåºæ’­æ”¾ -> éšæœºæ’­æ”¾ -> ä¸é‡å¤éšæœºæ’­æ”¾ -> é¡ºåºæ’­æ”¾
        if (playMode === 'order') {
            playMode = 'random';
        } else if (playMode === 'random') {
            playMode = 'random-no-repeat';
            // é‡ç½®å·²æ’­æ”¾æ­Œæ›²é›†åˆ
            playedSongs.clear();
        } else {
            playMode = 'order';
        }
        renderPlayList();
        // ä¿å­˜æ’­æ”¾æ¨¡å¼åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('playMode', playMode);
    }

    // æ–°å¢ï¼šæ’­æ”¾ä¸Šä¸€é¦–
    function playPrev(e) {
        e.stopPropagation();
        if (playList.length === 0) return;

        // Add current song to history before changing index
        if (playIndex !== -1) {
            addToHistory(playIndex);
        }

        if (playMode === 'random') {
            let nextIndex;
            // Select a random index that is not the current or in history
            do {
                nextIndex = Math.floor(Math.random() * playList.length);
            } while ((nextIndex === playIndex && playList.length > 1) || (playList.length > MAX_HISTORY_SIZE && playHistory.includes(nextIndex)));
            playIndex = nextIndex;
        } else if (playMode === 'random-no-repeat') {
            // å¦‚æœæ‰€æœ‰æ­Œæ›²éƒ½å·²æ’­æ”¾è¿‡ï¼Œé‡ç½®å·²æ’­æ”¾é›†åˆ
            if (playedSongs.size >= playList.length) {
                playedSongs.clear();
            }
            
            // ä»æœªæ’­æ”¾çš„æ­Œæ›²ä¸­éšæœºé€‰æ‹©
            let availableIndices = [];
            for (let i = 0; i < playList.length; i++) {
                if (!playedSongs.has(i)) {
                    availableIndices.push(i);
                }
            }
            
            // ä»å¯ç”¨ç´¢å¼•ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            let randomIndex = Math.floor(Math.random() * availableIndices.length);
            playIndex = availableIndices[randomIndex];
            
            // è®°å½•è¿™é¦–æ­Œå·²æ’­æ”¾
            playedSongs.add(playIndex);
        } else {
            playIndex = (playIndex - 1 + playList.length) % playList.length;
        }
        fetchThreadContentAndPlay(playList[playIndex]);
    }

    // æ–°å¢ï¼šæ’­æ”¾ä¸‹ä¸€é¦–
    function playNext(e) {
        e.stopPropagation();
        if (playList.length === 0) return;

        // Add current song to history before changing index
        if (playIndex !== -1) {
            addToHistory(playIndex);
        }

        if (playMode === 'random') {
            let nextIndex;
            // Select a random index that is not the current or in history
            do {
                nextIndex = Math.floor(Math.random() * playList.length);
            } while ((nextIndex === playIndex && playList.length > 1) || (playList.length > MAX_HISTORY_SIZE && playHistory.includes(nextIndex)));
            playIndex = nextIndex;
        } else if (playMode === 'random-no-repeat') {
            // å¦‚æœæ‰€æœ‰æ­Œæ›²éƒ½å·²æ’­æ”¾è¿‡ï¼Œé‡ç½®å·²æ’­æ”¾é›†åˆ
            if (playedSongs.size >= playList.length) {
                playedSongs.clear();
            }
            
            // ä»æœªæ’­æ”¾çš„æ­Œæ›²ä¸­éšæœºé€‰æ‹©
            let availableIndices = [];
            for (let i = 0; i < playList.length; i++) {
                if (!playedSongs.has(i)) {
                    availableIndices.push(i);
                }
            }
            
            // ä»å¯ç”¨ç´¢å¼•ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            let randomIndex = Math.floor(Math.random() * availableIndices.length);
            playIndex = availableIndices[randomIndex];
            
            // è®°å½•è¿™é¦–æ­Œå·²æ’­æ”¾
            playedSongs.add(playIndex);
        } else {
            playIndex = (playIndex + 1) % playList.length;
        }
        fetchThreadContentAndPlay(playList[playIndex]);
    }

    // æ–°å¢ï¼šç‚¹å‡»æ’­æ”¾åˆ—è¡¨åˆ‡æ­Œ
    function playFromList(idx) {
        // Add current song to history before changing index
        if (playIndex !== -1) {
            addToHistory(playIndex);
        }
        playIndex = idx;
        fetchThreadContentAndPlay(playList[playIndex]);
    }// æ–°å¢ï¼šæ ¹æ®songå¯¹è±¡è·å–è¯¦æƒ…å¹¶æ’­æ”¾
    function fetchThreadContentAndPlay(song) {
        if (!song || !song.threadId) {
            console.error('æ— æ•ˆçš„æ­Œæ›²æ•°æ®:', song);
            return;
        }

        console.log('å¼€å§‹æ’­æ”¾æ­Œæ›²:', song);
        currentMusicInfo = song.musicInfo;

        fetch(`/music/${song.threadId}`)
            .then(res => res.json())
            .then(detail => {
                console.log('è·å–åˆ°æ­Œæ›²è¯¦æƒ…:', detail);
                displayMusicDetail(detail);
            })
            .catch(err => {
                console.error('æ’­æ”¾å¤±è´¥:', err);
            });
    }

    // New: Function to add index to history
    function addToHistory(index) {
        // Prevent adding if history already contains the index (e.g., clicking the same song in playlist)
        if (!playHistory.includes(index)) {
            playHistory.push(index);
            // Keep history size limited
            if (playHistory.length > MAX_HISTORY_SIZE) {
                playHistory.shift(); // Remove the oldest entry
            }
        }
        // console.log('Play History:', playHistory); // Optional: log history for debugging
    }

    // æ’­æ”¾/æš‚åœé”®æ§åˆ¶
    function setupSpacebarControl() {
        document.addEventListener('keydown', (e) => {
            // 32 æ˜¯ç©ºæ ¼é”®çš„ keyCode
            if (e.keyCode === 32 || e.key === ' ') {
                // æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰æ´»åŠ¨çš„è¾“å…¥æ¡†
                const activeElement = document.activeElement;
                const isInputActive = activeElement && (
                    activeElement.tagName === 'INPUT' ||
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.isContentEditable
                );

                // å¦‚æœä¸æ˜¯åœ¨è¾“å…¥æ¡†ä¸­ï¼Œåˆ™æ§åˆ¶æ’­æ”¾/æš‚åœ
                if (!isInputActive) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ»šåŠ¨é¡µé¢ï¼‰

                    const player = document.querySelector('.music-player');
                    if (player && player.audio) {
                        if (player.audio.paused) {
                            player.audio.play();
                            player.querySelector('.play-icon').innerHTML = svgPause;
                            // æ˜¾ç¤ºæç¤º
                            showTemporaryMessage('æ’­æ”¾ (ç©ºæ ¼é”®)');
                        } else {
                            player.audio.pause();
                            player.querySelector('.play-icon').innerHTML = svgPlay;
                            // æ˜¾ç¤ºæç¤º
                            showTemporaryMessage('æš‚åœ (ç©ºæ ¼é”®)');
                        }
                    }
                }
            }
        });
    }

    // æ·»åŠ ä¸´æ—¶æ¶ˆæ¯æç¤º
    function showTemporaryMessage(message) {
        // åˆ›å»ºæˆ–è·å–æ¶ˆæ¯å…ƒç´ 
        let msgElem = document.getElementById('temp-message');
        if (!msgElem) {
            msgElem = document.createElement('div');
            msgElem.id = 'temp-message';
            msgElem.style.position = 'fixed';
            msgElem.style.top = '20px';
            msgElem.style.left = '50%';
            msgElem.style.transform = 'translateX(-50%)';
            msgElem.style.padding = '8px 16px';
            msgElem.style.background = 'rgba(0,0,0,0.7)';
            msgElem.style.color = 'white';
            msgElem.style.borderRadius = '4px';
            msgElem.style.zIndex = '9999';
            msgElem.style.opacity = '0';
            msgElem.style.transition = 'opacity 0.3s ease';
            document.body.appendChild(msgElem);
        }

        // è®¾ç½®æ¶ˆæ¯å¹¶æ˜¾ç¤º
        msgElem.textContent = message;
        msgElem.style.opacity = '1';

        // æ˜¾ç¤ºæç¤ºçš„å®é™…æ’­æ”¾çŠ¶æ€
        const player = document.querySelector('.music-player');
        if (player && player.audio) {
            if (message === 'æ’­æ”¾ (ç©ºæ ¼é”®)' && player.audio.paused) {
                msgElem.textContent = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡è¯•';
            }
            if (message === 'æš‚åœ (ç©ºæ ¼é”®)' && !player.audio.paused) {
                msgElem.textContent = 'æš‚åœå¤±è´¥ï¼Œè¯·ç‚¹å‡»æš‚åœæŒ‰é’®é‡è¯•';
            }
        }

        // 2ç§’åæ·¡å‡º
        setTimeout(() => {
            msgElem.style.opacity = '0';
        }, 2000);
    }

    // ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    function savePlaybackState(detail, currentTime) {
        // ç¡®ä¿ä¸åœ¨æš‚åœçŠ¶æ€æ—¶ä¿å­˜ï¼ˆé¿å…è¦†ç›–æœ‰æ•ˆçŠ¶æ€ï¼‰
        const player = document.querySelector('.music-player');
        if (player && player.audio && player.audio.paused) {
            return;
        }

        // è·å–å½“å‰æ’­æ”¾çš„æ­Œæ›²
        const currentSong = playList[playIndex];
        if (!currentSong) return;

        // ç¡®ä¿musicInfoå­˜åœ¨ä¸”åŒ…å«å®Œæ•´ä¿¡æ¯
        const musicInfo = {
            title: currentMusicInfo?.title || currentSong.musicInfo?.title || currentSong.parsedTitle || 'æœªçŸ¥æ­Œæ›²',
            artist: currentMusicInfo?.artist || currentSong.musicInfo?.artist || currentSong.parsedArtist || 'æœªçŸ¥è‰ºæœ¯å®¶'
        };

        // ä¿å­˜å½“å‰æ’­æ”¾çš„æ­Œæ›²ä¿¡æ¯
        const playbackState = {
            threadId: currentSong.threadId,
            currentTime: currentTime || 0,
            musicInfo: musicInfo,
            musicDetail: {
                musicUrl: detail.musicUrl,
                rawKey: detail.rawKey,
                generateParamString: detail.generateParamString,
                coverImage: detail.coverImage
            },
            volume: player?.audio?.volume || 1,
            timestamp: Date.now()
        };

        localStorage.setItem('playbackState', JSON.stringify(playbackState));
        console.log('æ’­æ”¾çŠ¶æ€å·²ä¿å­˜:', currentTime);
    }

    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ’­æ”¾çŠ¶æ€
    async function restorePlaybackState() {
        try {
            const savedState = localStorage.getItem('playbackState');
            if (!savedState) return false;

            const state = JSON.parse(savedState);
            console.log('æ‰¾åˆ°ä¿å­˜çš„æ’­æ”¾çŠ¶æ€:', state);

            // æ£€æŸ¥ä¿å­˜çš„çŠ¶æ€æ˜¯å¦æœ‰æ•ˆï¼ˆä¸è¶…è¿‡24å°æ—¶ï¼‰
            const now = Date.now();
            const maxAge = 24 * 60 * 60 * 1000; // 24å°æ—¶
            if (now - state.timestamp > maxAge) {
                console.log('ä¿å­˜çš„æ’­æ”¾çŠ¶æ€å·²è¿‡æœŸ');
                localStorage.removeItem('playbackState');
                return false;
            }

            // é¦–å…ˆæŸ¥çœ‹æ’­æ”¾åˆ—è¡¨ä¸­æ˜¯å¦å·²æœ‰è¯¥æ­Œæ›²
            let songIndex = playList.findIndex(song => song.threadId === state.threadId);

            // å¦‚æœæ’­æ”¾åˆ—è¡¨ä¸­æ²¡æœ‰è¯¥æ­Œæ›²ï¼Œåˆ™éœ€è¦è·å–å¹¶æ·»åŠ 
            if (songIndex === -1 && state.threadId) {
                // ç¡®ä¿musicInfoåŒ…å«å®Œæ•´çš„titleå’Œartistä¿¡æ¯
                const musicInfo = {
                    title: state.musicInfo?.title || 'æœªçŸ¥æ­Œæ›²',
                    artist: state.musicInfo?.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'
                };

                // å°†æ­Œæ›²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ï¼Œç¡®ä¿åŒ…å«å®Œæ•´ä¿¡æ¯
                playList.unshift({
                    threadId: state.threadId,
                    musicInfo: musicInfo,
                    parsedTitle: musicInfo.title,
                    parsedArtist: musicInfo.artist
                });
                songIndex = 0;
            }

            if (songIndex !== -1) {
                // è®¾ç½®æ’­æ”¾ç´¢å¼•å¹¶è·å–æ­Œæ›²è¯¦æƒ…
                playIndex = songIndex;

                // ç¡®ä¿currentMusicInfoåŒ…å«å®Œæ•´ä¿¡æ¯
                currentMusicInfo = {
                    title: state.musicInfo?.title || playList[songIndex].musicInfo?.title || 'æœªçŸ¥æ­Œæ›²',
                    artist: state.musicInfo?.artist || playList[songIndex].musicInfo?.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'
                };

                // è·å–è¯¦ç»†ä¿¡æ¯å¹¶æ’­æ”¾
                const response = await fetch(`/music/${state.threadId}`);
                if (!response.ok) throw new Error('æ— æ³•è·å–æ­Œæ›²è¯¦æƒ…');

                const detail = await response.json();

                // æ˜¾ç¤ºéŸ³ä¹è¯¦æƒ…ï¼ˆä¸è‡ªåŠ¨æ’­æ”¾ï¼‰
                displayMusicDetail(detail, false);

                // è®¾ç½®æ’­æ”¾è¿›åº¦å’ŒéŸ³é‡
                setTimeout(() => {
                    const player = document.querySelector('.music-player');
                    if (player && player.audio) {
                        player.audio.currentTime = state.currentTime || 0;
                        // New: Prioritize saved volume from playback state
                        const volumeToSet = state.volume !== undefined ? state.volume : parseFloat(localStorage.getItem('musicVolume') || '1.0');
                        player.audio.volume = volumeToSet;

                        // æ˜¾ç¤ºæç¤º
                        showTemporaryMessage('å·²æ¢å¤ä¸Šæ¬¡æ’­æ”¾çš„æ­Œæ›²');
                    }
                }, 1000);

                return true;
            }
        } catch (error) {
            console.error('æ¢å¤æ’­æ”¾çŠ¶æ€å¤±è´¥:', error);
        }

        return false;
    }

    // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®ç©ºæ ¼é”®æ§åˆ¶
    document.addEventListener('DOMContentLoaded', () => {
        setupSpacebarControl();
        initializeApp();

        // New: Initialize playHistory from localStorage if needed (optional)
        // This would require serializing/deserializing the history array
        // For simplicity, starting with empty history on load for now.
    });

    // åœ¨é¡µé¢å³å°†å…³é—­æ—¶ä¿å­˜å½“å‰çŠ¶æ€
    window.addEventListener('beforeunload', () => {
        const player = document.querySelector('.music-player');
        if (player && player.audio && !player.audio.paused && playList[playIndex]) {
            const detail = {
                musicUrl: player.dataset.musicUrl || '',
                rawKey: player.dataset.rawKey || '',
                generateParamString: player.dataset.generateParamString || '',
                coverImage: player.querySelector('.player-cover')?.src || ''
            };
            savePlaybackState(detail, player.audio.currentTime);
        }
    });

    // åˆ·æ–°é¦–é¡µæ•°æ®
    async function refreshFirstPage() {
        if (isLoadingMore) return;

        // å…ˆæ£€æŸ¥CookieçŠ¶æ€
        const cookieValid = await checkCookieStatus();
        if (!cookieValid) {
            return; // å¦‚æœCookieæ— æ•ˆï¼Œåœæ­¢åˆ·æ–°
        }

        isLoadingMore = true;
        const loading = document.querySelector('.loading');
        const error = document.querySelector('.error');
        const refreshBtn = document.getElementById('refreshBtn');

        loading.style.display = 'block';
        error.style.display = 'none';
        refreshBtn.disabled = true;

        try {
            updateStatus(`æ­£åœ¨è·å–æ–°æ­Œæ›²æ•°æ®...`);
            const pageData = await fetchPage(1); // å§‹ç»ˆè·å–ç¬¬ä¸€é¡µ

            // è¿‡æ»¤æ‰æ’é™¤çš„çº¿ç¨‹ID
            const filteredData = filterExcludedThreads(pageData);

            // è®°å½•å½“å‰æ•°æ®çš„IDsä»¥ä¾¿å¯¹æ¯”
            const existingIds = getExistingIds();

            // è¿‡æ»¤å‡ºæ–°æ•°æ®
            const newData = filteredData.filter(item => !existingIds.has(item.threadId));

            if (newData.length === 0) {
                updateStatus(`æ²¡æœ‰å‘ç°æ–°çš„æ­Œæ›²æ•°æ®`);
            } else {
                // å°†æ–°æ•°æ®æ·»åŠ åˆ°ç°æœ‰æ•°æ®çš„å¼€å¤´
                allMusicData = [...newData, ...allMusicData];

                // å…ˆç§»é™¤æ‰€æœ‰ä¹‹å‰çš„æ–°æ­Œæ ‡è®°
                document.querySelectorAll('.music-item.new-item').forEach(item => {
                    item.classList.remove('new-item');
                });

                // åœ¨å½“å‰åˆ—è¡¨å‰é¢æ·»åŠ æ–°æ­Œæ›²
                const musicList = document.getElementById('musicList');
                const numRows = 10;
                const numCols = Math.ceil(newData.length / numRows);

                // åˆ›å»ºä¸€ä¸ªäºŒç»´æ•°ç»„ç”¨äºé‡æ’æ•°æ®
                let reorderedNewData = [];
                for (let col = 0; col < numCols; col++) {
                    for (let row = 0; row < numRows; row++) {
                        const index = col * numRows + row;
                        if (index < newData.length) {
                            reorderedNewData.push(newData[index]);
                        }
                    }
                }

                // åˆ›å»ºä¸´æ—¶å®¹å™¨ä»¥ä¿å­˜æ–°é¡¹ç›®
                const tempContainer = document.createDocumentFragment();

                // æ·»åŠ æ–°æ­Œæ›²åˆ°ä¸´æ—¶å®¹å™¨
                reorderedNewData.forEach(item => {
                    const musicInfo = parseMusicInfo(item.title);
                    const musicItem = document.createElement('div');
                    musicItem.className = 'music-item new-item'; // æ·»åŠ new-itemç±»æ ‡è®°ä¸ºæ–°æ•°æ®

                    // åˆ›å»ºåŸºæœ¬ä¿¡æ¯å±•ç¤º
                    musicItem.innerHTML = `
              <div class="music-title">${musicInfo.title}</div>
              <div class="music-author">${musicInfo.artist}</div>
              <div class="music-item-action music-item-play">
                <span class="music-item-icon">â–¶ï¸</span>
              </div>
              <div class="music-item-action music-item-add">
                <span class="music-item-icon">+</span>
              </div>
            `;

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    const playAction = musicItem.querySelector('.music-item-play');
                    const addAction = musicItem.querySelector('.music-item-add');

                    // ç«‹å³æ’­æ”¾
                    playAction.onclick = (e) => {
                        e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                        item.parsedTitle = musicInfo.title;
                        item.parsedArtist = musicInfo.artist;

                        // æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨çš„ç¬¬ä¸€è¡Œå¹¶ç«‹å³æ’­æ”¾
                        playList = playList.filter(s => s.threadId !== item.threadId); // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç›¸åŒæ­Œæ›²
                        playList.unshift({  // ä½¿ç”¨unshiftæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                            ...item,
                            musicInfo: musicInfo
                        });
                        playIndex = 0;  // è®¾ç½®ä¸ºç¬¬ä¸€é¦–æ­Œæ›²
                        fetchThreadContentAndPlay(playList[playIndex]);
                    };

                    // ä»…æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
                    addAction.onclick = (e) => {
                        e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                        item.parsedTitle = musicInfo.title;
                        item.parsedArtist = musicInfo.artist;

                        // åŠ å…¥æ’­æ”¾åˆ—è¡¨
                        addToPlayList({
                            ...item,
                            musicInfo: musicInfo
                        });
                    };

                    tempContainer.appendChild(musicItem);
                });

                // å°†æ–°çš„æ­Œæ›²é¡¹æ’å…¥åˆ°åˆ—è¡¨çš„å¼€å¤´
                if (musicList.firstChild) {
                    musicList.insertBefore(tempContainer, musicList.firstChild);
                } else {
                    musicList.appendChild(tempContainer);
                }

                updateStatus(`å·²æ·»åŠ  ${newData.length} é¦–æ–°æ­Œæ›²ï¼Œæ€»è®¡ ${allMusicData.length} é¦–æ­Œæ›²`);

                // ç¡®ä¿å¯ä»¥ç»§ç»­æ— é™æ»šåŠ¨
                hasMoreData = true;
            }
        } catch (err) {
            error.textContent = 'è·å–æ–°æ•°æ®å¤±è´¥: ' + err.message;
            error.style.display = 'block';
        } finally {
            isLoadingMore = false;
            loading.style.display = 'none';
            refreshBtn.disabled = false;
        }
    }

    // Cookieå¤„ç†å‡½æ•°
    function setupCookieModal() {
        const cookieSettingsBtn = document.getElementById('cookieSettingsBtn');
        const cookieModal = document.getElementById('cookieModal');
        const closeCookieModal = document.getElementById('closeCookieModal');
        const cookieInput = document.getElementById('cookieInput');
        const cookieResult = document.getElementById('cookieResult');
        const parseCookieBtn = document.getElementById('parseCookieBtn');
        const saveCookieBtn = document.getElementById('saveCookieBtn');

        // æ‰“å¼€å¯¹è¯æ¡†
        cookieSettingsBtn.addEventListener('click', () => {
            showCookieModal(false);
        });

        // å…³é—­å¯¹è¯æ¡†
        closeCookieModal.addEventListener('click', () => {
            cookieModal.style.display = 'none';
        });

        // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target === cookieModal && cookieModal.dataset.forced !== 'true') {
                cookieModal.style.display = 'none';
            }
        });

        // è§£æå¹¶ä¿å­˜Cookie
        parseCookieBtn.addEventListener('click', async () => {
            try {
                const cookieJson = cookieInput.value.trim();
                let cookieArray;

                try {
                    cookieArray = JSON.parse(cookieJson);
                } catch (e) {
                    throw new Error('Cookie JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                }

                if (!Array.isArray(cookieArray)) {
                    throw new Error('Cookieæ ¼å¼å¿…é¡»æ˜¯æ•°ç»„');
                }

                // æ„å»ºCookieå­—ç¬¦ä¸²
                const cookieStr = cookieArray
                    .filter(cookie => cookie.name && cookie.value)
                    .map(cookie => `${cookie.name}=${cookie.value}`)
                    .join('; ');

                // æ˜¾ç¤ºç»“æœ
                cookieResult.style.display = 'block';
                cookieResult.textContent = cookieStr;

                // ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨
                updateStatus('æ­£åœ¨ä¿å­˜Cookie...');

                const response = await fetch('/api/setCookie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({cookie: cookieStr})
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    updateStatus('Cookieè®¾ç½®æˆåŠŸ');
                    cookieModal.style.display = 'none';
                    // åˆ·æ–°æ•°æ®
                    refreshFirstPage();
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                updateStatus(`Cookieè®¾ç½®å¤±è´¥: ${error.message}`);
                cookieResult.style.display = 'block';
                cookieResult.textContent = `é”™è¯¯: ${error.message}`;
            }
        });

        // ç§»é™¤ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œå› ä¸ºç°åœ¨è§£ææ—¶å°±ç›´æ¥ä¿å­˜äº†
        saveCookieBtn.style.display = 'none';
    }

    // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ æ’­æ”¾åˆ—è¡¨ç¼“å­˜åŠŸèƒ½
    async function initializeApp() {
        const loading = document.querySelector('.loading');
        loading.style.display = 'block';

        try {
            // é¦–å…ˆæ£€æŸ¥CookieçŠ¶æ€
            const cookieValid = await checkCookieStatus();
            console.log('CookieçŠ¶æ€:', cookieValid);

            // æ ¹æ®cookieçŠ¶æ€æ§åˆ¶è®¾ç½®æŒ‰é’®æ˜¾ç¤º
            const cookieSettingsBtn = document.getElementById('cookieSettingsBtn');
            if (cookieSettingsBtn) {
                // cookieSettingsBtn.style.display = cookieValid ? 'none' : 'block';
            }

            if (cookieValid) {
                // 1. ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¹¶æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
                const savedPlayList = localStorage.getItem('playList');
                const savedPlayIndex = localStorage.getItem('playIndex');
                const savedPlayMode = localStorage.getItem('playMode');
                if (savedPlayList) {
                    try {
                        const parsedList = JSON.parse(savedPlayList);
                        // éªŒè¯å¹¶æ¢å¤æ’­æ”¾åˆ—è¡¨é¡¹å®Œæ•´æ€§
                        playList = parsedList.map(item => {
                            const title = item.musicInfo?.title || item.parsedTitle || '';
                            const artist = item.musicInfo?.artist || item.parsedArtist || '';
                            return {
                                threadId: item.threadId,
                                musicInfo: {title, artist},
                                parsedTitle: title,
                                parsedArtist: artist
                            };
                        });
                        playIndex = parseInt(savedPlayIndex) >= 0 ? parseInt(savedPlayIndex) : 0;
                        playMode = savedPlayMode || 'order';
                    } catch (e) {
                        console.error('åŠ è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥:', e);
                        playList = [];
                        playIndex = -1;
                    }
                }
                // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
                renderPlayList();
                // 2. æ¢å¤ä¸Šæ¬¡æ’­æ”¾çŠ¶æ€ï¼ˆè‹¥å­˜åœ¨ï¼‰
                const playbackRestored = await restorePlaybackState();
                console.log('æ¢å¤æ’­æ”¾çŠ¶æ€ç»“æœ:', playbackRestored);
                // å¦‚æœæ²¡æœ‰æ¢å¤ä¸”æœ‰æ’­æ”¾åˆ—è¡¨ï¼Œåˆ™æ’­æ”¾åˆ—è¡¨ä¸­çš„ç¬¬ä¸€é¦–æˆ–savedPlayIndexæŒ‡å®šçš„æ­Œæ›²
                if (!playbackRestored && playList.length > 0) {
                    const idx = playIndex >= 0 && playIndex < playList.length ? playIndex : 0;
                    fetchThreadContentAndPlay(playList[idx]);
                }

                // 3. åŠ è½½æ›´å¤šæ­Œæ›²å¹¶è®¾ç½®æ— é™æ»šåŠ¨
                await loadMoreData();
                setupInfiniteScroll();
            }

            // æ·»åŠ åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', refreshFirstPage);

            // è®¾ç½®Cookieå¯¹è¯æ¡†
            setupCookieModal();

            // ç¡®ä¿æ’­æ”¾å™¨å®¹å™¨å¯è§ï¼Œå¹¶è®¾ç½®é»˜è®¤å†…å®¹
            const playerContainer = document.getElementById('playerContainer');
            const musicPlayer = document.getElementById('musicPlayer');
            playerContainer.style.display = 'flex';

            // å¦‚æœæ²¡æœ‰æ’­æ”¾åˆ—è¡¨ï¼Œæ‰æ˜¾ç¤ºé»˜è®¤å†…å®¹
            if (!playList || playList.length === 0) {
                musicPlayer.innerHTML = `
            <div class="player-header-draggable">
              <img src="https://lixingyu.cn/star.ico" class="player-cover"/>
              <div class="player-info">
                <div class="player-title">æ¬¢è¿ä½¿ç”¨ HiFiNi Music</div>
                <div class="player-author">ç‚¹å‡»éŸ³ä¹å¼€å§‹æ’­æ”¾ (ç©ºæ ¼é”®æš‚åœ/æ’­æ”¾)</div>
              </div>
            </div>
            <div class="player-controls">
              <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
              <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
              <div class="player-time">0:00 / 0:00</div>
              <div class="player-volume">
                <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${svgVolume}</span></button>
                <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:100%"></div></div>
              </div>
            </div>
          `;
            }

            // è®¾ç½®æ‹–åŠ¨è°ƒæ•´å®½åº¦åŠŸèƒ½
            setupResizer();
        } finally {
            loading.style.display = 'none';
        }
    }

    // æ›´æ–°åˆ†éš”æ¡ä½ç½®
    function updateResizerPosition() {
        const playerContainer = document.getElementById('playerContainer');
        const resizer = document.getElementById('resizer');

        // åˆ†éš”æ¡ä½ç½®ä¸æ’­æ”¾å™¨å·¦è¾¹ç•Œå¯¹é½
        resizer.style.right = playerContainer.offsetWidth + 'px';

        // è°ƒè¯•æ—¥å¿—
        console.log('æ›´æ–°åˆ†éš”æ¡ä½ç½®, æ’­æ”¾å™¨å®½åº¦:', playerContainer.offsetWidth);
    }

    // æ›¿æ¢setupResizerå‡½æ•°ä¸­çš„ç§»åŠ¨å¤„ç†é€»è¾‘
    function setupResizer() {
        const resizer = document.getElementById('resizer');
        const container = document.querySelector('.container');
        const playerContainer = document.getElementById('playerContainer');

        // åˆå§‹åŒ–åˆ†éš”æ¡ä½ç½®
        updateResizerPosition();

        let isResizing = false;
        let lastX = 0;

        // ä¿®å¤æ‹–æ‹½äº‹ä»¶
        resizer.addEventListener('mousedown', function (e) {
            isResizing = true;
            resizer.classList.add('active');
            lastX = e.clientX;

            // é˜²æ­¢é€‰ä¸­æ–‡æœ¬
            document.body.style.userSelect = 'none';

            function onMouseMove(e) {
                if (!isResizing) return;

                // è®¡ç®—ç§»åŠ¨è·ç¦»
                const dx = e.clientX - lastX;
                lastX = e.clientX;

                // è·å–å½“å‰å®½åº¦
                const currentPlayerWidth = playerContainer.offsetWidth;

                // è®¡ç®—æ–°çš„æ’­æ”¾å™¨å®½åº¦
                const minWidth = 300; // æœ€å°å®½åº¦
                const maxWidth = window.innerWidth - 300; // æœ€å¤§å®½åº¦ï¼ˆç•™å‡ºå·¦ä¾§æœ€å°ç©ºé—´ï¼‰

                // è®¡ç®—æ–°çš„æ’­æ”¾å™¨å®½åº¦
                let newPlayerWidth = Math.min(maxWidth, Math.max(minWidth, currentPlayerWidth - dx));

                // æ›´æ–°æ’­æ”¾å™¨å®½åº¦ - æ˜¾å¼è®¾ç½®ä¸ºå›ºå®šåƒç´ å€¼
                playerContainer.style.width = newPlayerWidth + 'px';

                // æ›´æ–°å†…å®¹åŒºå®½åº¦
                container.style.width = `calc(100% - ${newPlayerWidth}px)`;

                // æ›´æ–°åˆ†éš”æ¡ä½ç½®
                updateResizerPosition();

                // è°ƒè¯•
                console.log('æ‹–æ‹½ä¸­, æ–°å®½åº¦:', newPlayerWidth);
            }

            function onMouseUp() {
                isResizing = false;
                resizer.classList.remove('active');
                document.body.style.userSelect = '';

                // ä¿å­˜æœ€ç»ˆå®½åº¦åˆ°localStorage
                const finalWidth = playerContainer.offsetWidth;
                localStorage.setItem('playerWidth', finalWidth);
                console.log('æ‹–æ‹½ç»“æŸ, ä¿å­˜å®½åº¦:', finalWidth);

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);

            // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
            e.stopPropagation();
            e.preventDefault();
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°åˆ†éš”æ¡ä½ç½®
        window.addEventListener('resize', updateResizerPosition);

        // å°è¯•ä»localStorageæ¢å¤å®½åº¦
        const savedWidth = localStorage.getItem('playerWidth');
        if (savedWidth) {
            const width = parseInt(savedWidth);
            if (!isNaN(width) && width >= 300) {
                playerContainer.style.width = width + 'px';
                container.style.width = `calc(100% - ${width}px)`;
                updateResizerPosition();
                console.log('æ¢å¤ä¿å­˜çš„å®½åº¦:', width);
            }
        }
    }

    // åœ¨è„šæœ¬æœ€å‰é¢å®šä¹‰SVGå˜é‡ï¼š
    const svgPlay = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 17,10 5,17" fill="#fff"/></svg>`;
    const svgPause = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="3" width="4" height="14" rx="1" fill="#fff"/><rect x="12" y="3" width="4" height="14" rx="1" fill="#fff"/></svg>`;
    const svgPrev = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="15,3 7,10 15,17" fill="#fff"/><rect x="4" y="3" width="2" height="14" rx="1" fill="#fff"/></svg>`;
    const svgNext = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 13,10 5,17" fill="#fff"/><rect x="14" y="3" width="2" height="14" rx="1" fill="#fff"/></svg>`;
    const svgVolume = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="3,8 7,8 12,4 12,16 7,12 3,12" fill="#fff"/></svg>`;
    const svgMute = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="3,8 7,8 12,4 12,16 7,12 3,12" fill="#fff"/><line x1="15" y1="7" x2="19" y2="13" stroke="#fff" stroke-width="2"/><line x1="19" y1="7" x2="15" y2="13" stroke="#fff" stroke-width="2"/></svg>`;
    const svgOrder = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="9" width="14" height="2" rx="1" fill="#fff"/></svg>`;
    const svgShuffle = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4L16 16M16 4L4 16" stroke="#fff" stroke-width="2"/></svg>`;

    // åˆ é™¤æ’­æ”¾åˆ—è¡¨ä¸­çš„å•ä¸ªæ­Œæ›²
    function removeFromPlayList(index, e) {
        e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…ç‚¹å‡»åˆ é™¤æŒ‰é’®æ—¶è§¦å‘æ’­æ”¾

        // ä¸å…è®¸åˆ é™¤å½“å‰æ’­æ”¾çš„æ­Œæ›²
        if (index === playIndex) {
            showTemporaryMessage('æ— æ³•åˆ é™¤å½“å‰æ’­æ”¾çš„æ­Œæ›²');
            return;
        }

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾æ­Œæ›²ä¹‹å‰çš„æ­Œæ›²ï¼Œéœ€è¦è°ƒæ•´playIndex
        if (index < playIndex) {
            playIndex--;
        }

        // ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤
        playList.splice(index, 1);

        // é‡æ–°æ¸²æŸ“æ’­æ”¾åˆ—è¡¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        renderPlayList();
        showTemporaryMessage('å·²ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤');
    }

    // æ¸…ç©ºæ’­æ”¾åˆ—è¡¨ï¼ˆä¿ç•™å½“å‰æ’­æ”¾çš„æ­Œæ›²ï¼‰
    function clearPlayList(e) {
        e.stopPropagation();

        // If list is empty or only one song, or if there's no currently playing song
        if (playList.length <= 1) {
            showTemporaryMessage('æ’­æ”¾åˆ—è¡¨å·²ä¸ºç©º');
            return;
        }

        // å¦‚æœæœ‰å½“å‰æ’­æ”¾çš„æ­Œæ›²ï¼Œä¿ç•™å®ƒ
        if (playIndex !== -1) {
            const currentSong = playList[playIndex];
            playList = [currentSong];
            playIndex = 0;
        } else {
            // å¦‚æœæ²¡æœ‰å½“å‰æ’­æ”¾çš„æ­Œæ›²ï¼Œå®Œå…¨æ¸…ç©º
            playList = [];
            playIndex = -1;
            // New: Clear history when playlist is cleared
            playHistory = [];
        }

        // é‡æ–°æ¸²æŸ“æ’­æ”¾åˆ—è¡¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        renderPlayList();
        showTemporaryMessage('å·²æ¸…ç©ºæ’­æ”¾åˆ—è¡¨(ä¿ç•™å½“å‰æ’­æ”¾æ­Œæ›²)');
    }

    // æ·»åŠ æœç´¢ç›¸å…³å‡½æ•°
    function showSearchModal() {
        const searchModal = document.getElementById('searchModal');
        const searchInput = document.getElementById('searchInput');
        searchModal.style.display = 'block';
        searchInput.focus();
    }

    function hideSearchModal() {
        const searchModal = document.getElementById('searchModal');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        searchModal.style.display = 'none';
        searchInput.value = '';
        searchResults.innerHTML = '';
    }

    // æ·»åŠ æœç´¢æç¤º
    function showSearchTip() {
        const tip = document.createElement('div');
        tip.id = 'searchTip';
        tip.innerHTML = 'æŒ‰ S é”®æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®æœç´¢éŸ³ä¹';
        tip.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            transition: opacity 0.3s;
        `;
        document.body.appendChild(tip);

        // 3ç§’åæ·¡å‡º
        setTimeout(() => {
            tip.style.opacity = '0';
            setTimeout(() => tip.remove(), 300);
        }, 3000);
    }

    // æœç´¢é¡µé¢å…¨å±€å˜é‡
    let currentSearchKeyword = '';
    let currentSearchPage = 1;
    let hasMoreSearchResults = true;

    // ä¿®æ”¹æœç´¢éŸ³ä¹å‡½æ•°
    async function searchMusic(keyword, page = 1, append = false) {
        if (!keyword.trim()) {
            searchResults.innerHTML = '';
            return;
        }

        // æ›´æ–°å…¨å±€å˜é‡
        currentSearchKeyword = keyword;
        currentSearchPage = page;

        // å¦‚æœä¸æ˜¯è¿½åŠ æ¨¡å¼ï¼Œåˆ™æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
        if (!append) {
            searchResults.innerHTML = '<div class="search-loading">æœç´¢ä¸­...</div>';
        } else {
            // è¿½åŠ æ¨¡å¼ä¸‹åœ¨åˆ—è¡¨åº•éƒ¨æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'search-loading';
            loadingIndicator.textContent = 'åŠ è½½ä¸­...';
            loadingIndicator.id = 'searchLoadingIndicator';
            searchResults.appendChild(loadingIndicator);
        }

        try {
            // æ„å»ºæœç´¢URLï¼Œæ·»åŠ é¡µç æ”¯æŒ
            const searchUrl = page > 1
                ? `/api/search?keyword=${encodeURIComponent(keyword)}-1-${page}.htm`
                : `/api/search?keyword=${encodeURIComponent(keyword)}`;

            console.log('æœç´¢URL:', searchUrl);

            const response = await fetch(searchUrl);
            if (!response.ok) {
                throw new Error('æœç´¢è¯·æ±‚å¤±è´¥');
            }

            const results = await response.json();

            // å¦‚æœç»“æœå°‘äº20æ¡ï¼Œå¯èƒ½æ²¡æœ‰æ›´å¤šç»“æœäº†
            hasMoreSearchResults = results.length >= 20;

            // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
            if (append) {
                const loadingIndicator = document.getElementById('searchLoadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }

            // å‡†å¤‡HTML
            const resultsHtml = results.map(result => {
                const musicInfo = parseMusicInfo(result.title);
                return `
                    <div class="search-result-item" data-thread-id="${result.threadId}">
                        <div class="search-result-play-area" title="ç«‹å³æ’­æ”¾">
                            <div class="search-result-info">
                                <div class="search-result-title">${musicInfo.title}</div>
                                <div class="search-result-author">${musicInfo.artist}</div>
                            </div>
                            <div style="position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:0.5;">
                                <span class="search-result-icon">â–¶ï¸</span>
                            </div>
                        </div>
                        <div class="search-result-add-area" title="æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨">
                            <div class="search-result-icon">+</div>
                        </div>
                    </div>
                `;
            }).join('');

            // å¦‚æœæ˜¯è¿½åŠ æ¨¡å¼ï¼Œæ·»åŠ åˆ°ç°æœ‰ç»“æœåé¢
            if (append) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„åˆ†é¡µæ§ä»¶ï¼Œç¨åé‡æ–°æ·»åŠ 
                const existingPagination = document.getElementById('searchPagination');
                if (existingPagination) {
                    existingPagination.remove();
                }

                // è¿½åŠ æ–°ç»“æœ
                searchResults.insertAdjacentHTML('beforeend', resultsHtml);
            } else {
                // å®Œå…¨æ›¿æ¢ç»“æœ
                searchResults.innerHTML = resultsHtml;
            }

            // å¦‚æœæ²¡æœ‰ç»“æœï¼Œæ˜¾ç¤ºæç¤º
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                hasMoreSearchResults = false;
            }

            // æ·»åŠ åˆ†é¡µæ§ä»¶
            if (hasMoreSearchResults || page > 1) {
                const paginationHtml = `
                    <div class="search-pagination" id="searchPagination">
                        ${page > 1 ? `<button class="search-page-btn prev-page" data-page="${page - 1}">ä¸Šä¸€é¡µ</button>` : ''}
                        <span class="search-page-info">ç¬¬ ${page} é¡µ</span>
                        ${hasMoreSearchResults ? `<button class="search-page-btn next-page" data-page="${page + 1}">ä¸‹ä¸€é¡µ</button>` : ''}
                    </div>
                `;
                searchResults.insertAdjacentHTML('beforeend', paginationHtml);

                // æ·»åŠ åˆ†é¡µæŒ‰é’®äº‹ä»¶
                const prevBtn = document.querySelector('.search-page-btn.prev-page');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        const targetPage = parseInt(prevBtn.dataset.page);
                        searchMusic(currentSearchKeyword, targetPage);
                        // æ»šåŠ¨åˆ°é¡¶éƒ¨
                        document.querySelector('.search-results').scrollTop = 0;
                    });
                }

                const nextBtn = document.querySelector('.search-page-btn.next-page');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const targetPage = parseInt(nextBtn.dataset.page);
                        searchMusic(currentSearchKeyword, targetPage);
                        // æ»šåŠ¨åˆ°é¡¶éƒ¨
                        document.querySelector('.search-results').scrollTop = 0;
                    });
                }
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ”¹è¿›å¯è§†åŒ–æ•ˆæœ
            document.querySelectorAll('.search-result-item').forEach(item => {
                const threadId = item.dataset.threadId;
                // ä»æœç´¢ç»“æœä¸­ç›´æ¥è¯»å–æ ‡é¢˜å’Œæ­Œæ‰‹ä¿¡æ¯
                const title = item.querySelector('.search-result-title').textContent;
                const artist = item.querySelector('.search-result-author').textContent;

                // åˆ†ç¦»å·¦å³åŒºåŸŸ
                const playArea = item.querySelector('.search-result-play-area');
                const addArea = item.querySelector('.search-result-add-area');

                // å·¦ä¾§åŒºåŸŸç‚¹å‡»äº‹ä»¶ - ç«‹å³æ’­æ”¾å¹¶æ·»åŠ åˆ°åˆ—è¡¨ç¬¬ä¸€é¦–
                playArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const song = {
                        threadId: threadId,
                        musicInfo: {
                            title: title,
                            artist: artist
                        },
                        parsedTitle: title,
                        parsedArtist: artist
                    };

                    // æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨çš„ç¬¬ä¸€è¡Œå¹¶ç«‹å³æ’­æ”¾
                    playList = playList.filter(s => s.threadId !== threadId);
                    playList.unshift(song);
                    playIndex = 0;
                    fetchThreadContentAndPlay(playList[playIndex]);

                    // å…³é—­æœç´¢æ¡†
                    hideSearchModal();

                    // æ˜¾ç¤ºæç¤º
                    showTemporaryMessage('å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨å¹¶å¼€å§‹æ’­æ”¾');
                });

                // å³ä¾§åŒºåŸŸç‚¹å‡»äº‹ä»¶ - ä»…æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
                addArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const song = {
                        threadId: threadId,
                        musicInfo: {
                            title: title,
                            artist: artist
                        },
                        parsedTitle: title,
                        parsedArtist: artist
                    };

                    // åŠ å…¥æ’­æ”¾åˆ—è¡¨
                    addToPlayList(song);

                    // æ˜¾ç¤ºæç¤º
                    showTemporaryMessage('å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨');
                });

                // ä¸ºäº†æ›´å¥½çš„äº¤äº’æ•ˆæœï¼Œæ·»åŠ é¼ æ ‡æ‚¬åœé«˜äº®
                playArea.addEventListener('mouseenter', () => {
                    playArea.style.backgroundColor = '#f5f9ff';
                });

                playArea.addEventListener('mouseleave', () => {
                    playArea.style.backgroundColor = '';
                });

                addArea.addEventListener('mouseenter', () => {
                    addArea.style.backgroundColor = '#f5f9ff';
                });

                addArea.addEventListener('mouseleave', () => {
                    addArea.style.backgroundColor = '';
                });
            });

        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            if (!append) {
                searchResults.innerHTML = '<div class="search-error">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            } else {
                const loadingIndicator = document.getElementById('searchLoadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                }
            }
        }
    }

    // ä¿®æ”¹è®¾ç½®Cookieçš„å‡½æ•°
    async function setCookie(cookie) {
        try {
            const response = await fetch('/api/set-cookie', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({cookie: cookie})
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    // éšè—è®¾ç½®Cookieçš„æŒ‰é’®
                    const cookieButton = document.getElementById('setCookieButton');
                    if (cookieButton) {
                        cookieButton.style.display = 'none';
                    }
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert('Cookieè®¾ç½®æˆåŠŸï¼');
                    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
                    location.reload();
                } else {
                    alert('Cookieè®¾ç½®å¤±è´¥ï¼š' + result.message);
                }
            } else {
                alert('Cookieè®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('è®¾ç½®Cookieå¤±è´¥:', error);
            alert('è®¾ç½®Cookieå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæœç´¢æç¤º
    document.addEventListener('DOMContentLoaded', () => {
        showSearchTip();

        // æ£€æŸ¥CookieçŠ¶æ€
        fetch('/api/cookie-status')
            .then(response => response.json())
            .then(status => {
                if (status.hasCookie && !status.isExpired) {
                    const cookieButton = document.getElementById('setCookieButton');
                    if (cookieButton) {
                        cookieButton.style.display = 'none';
                    }
                }
            });
    });

    // ä¿®æ”¹äº‹ä»¶ç›‘å¬å™¨éƒ¨åˆ†
    document.addEventListener('keydown', function (e) {
        // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹Sé”®ï¼Œå¹¶ä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­
        if (e.key.toLowerCase() === 's' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            showSearchModal();
        }
        // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹Esc
        else if (e.key === 'Escape') {
            hideSearchModal();
        }
    });

    // æœç´¢è¾“å…¥é˜²æŠ–
    let searchTimeout = null;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        searchTimeout = setTimeout(() => {
            // é‡ç½®ä¸ºç¬¬1é¡µ
            currentSearchPage = 1;
            searchMusic(e.target.value, 1);
        }, 300);
    });

    // æœç´¢æ¡†æ·»åŠ å›è½¦é”®æ”¯æŒ
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            // é‡ç½®ä¸ºç¬¬1é¡µ
            currentSearchPage = 1;
            searchMusic(e.target.value, 1);
        }
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('searchModal').addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ¨¡æ€æ¡†æœ¬èº«ï¼ˆè€Œä¸æ˜¯å…¶å­å…ƒç´ ï¼‰ï¼Œåˆ™å…³é—­æœç´¢æ¡†
        if (e.target === document.getElementById('searchModal')) {
            hideSearchModal();
        }
    });

    // æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('searchBtn').addEventListener('click', showSearchModal);

    // é˜»æ­¢æœç´¢æ¡†å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
    document.querySelector('.search-modal-content').addEventListener('click', (e) => {
        e.stopPropagation();
    });
</script>
</body>

</html>
