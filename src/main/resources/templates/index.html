<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <link rel="shortcut icon" href="https://lixingyu.cn/star.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HiFiNi Music List</title>
  <link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      margin: 0;  /* 移除自动边距，使内容靠左 */
      padding: 20px;
      width: calc(100% - 500px); /* 为右侧播放器留出空间 */
      box-sizing: border-box;
      position: relative;
      float: left; /* 添加浮动，确保内容靠左 */
    }

    header {
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border-radius: 8px;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .btn {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background-color: #2980b9;
    }

    .btn:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    .music-list {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      align-content: flex-start;
      gap: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .music-item {
      width: 160px; /* 固定宽度 */
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border-radius: 8px;
      border: 1px solid #f2f2f2;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      background: #fff;
      position: relative;
    }

    .music-item:hover {
      background: #f0f6ff;
    }

    .music-item.new-item {
      background: #e8f5e9; /* 淡绿色背景标识新加载的数据 */
    }

    .music-item-action {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.7);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .music-item-play {
      left: 0;
      border-radius: 8px 0 0 8px;
    }

    .music-item-add {
      right: 0;
      border-radius: 0 8px 8px 0;
    }

    .music-item:hover .music-item-action {
      opacity: 1;
    }

    .music-item-icon {
      font-size: 18px;
      color: #3498db;
    }

    .music-title {
      font-weight: 700;
      color: #222;
      font-size: 15px;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .music-author {
      color: #999;
      font-size: 12px;
      font-weight: 400;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .loading {
      text-align: center;
      padding: 20px;
      display: none;
    }

    .loading::after {
      content: "Loading...";
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
      0%,
      20% {
        content: "Loading.   ";
      }

      40% {
        content: "Loading..  ";
      }

      60% {
        content: "Loading... ";
      }

      80% {
        content: "Loading....";
      }

      100% {
        content: "Loading.....";
      }
    }

    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
      display: none;
    }

    .status {
      text-align: center;
      color: #666;
      margin: 10px 0;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .page-btn {
      padding: 5px 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .page-btn.active {
      background-color: #3498db;
      color: white;
      border-color: #3498db;
    }

    /* 修改为固定播放器样式 */
    .player-container {
      position: fixed;
      right: 0;
      top: 0;
      width: 500px; /* 增加默认宽度 */
      z-index: 1000;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #fff;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px 15px;
      box-sizing: border-box; /* 确保padding不增加总宽度 */
      transition: all 0.3s ease; /* 添加过渡效果 */
    }

    .music-player {
      position: relative;
      width: 100%;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(52, 152, 219, 0.13);
      display: flex;
      flex-direction: column;
      padding: 24px;
      transition: all 0.3s ease;
      user-select: none;
      margin-bottom: 15px;
    }

    .player-header-draggable {
      display: flex;
      align-items: center;
      width: 100%;
      user-select: none;
      margin-bottom: 20px;
    }

    .music-player .player-cover {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: cover;
      margin-right: 20px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .music-player .player-cover:hover {
      transform: scale(1.05);
    }

    .music-player .player-info {
      flex: 1;
      min-width: 0;
    }

    .music-player .player-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
      transition: color 0.2s;
    }
    
    .music-player:hover .player-title {
      color: #3498db;
    }

    .music-player .player-author {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .music-player .player-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .music-player .player-btn,
    .playlist-panel-wrap .player-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3498db, #2980b9);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
      outline: none;
    }

    .music-player .player-btn:active,
    .playlist-panel-wrap .player-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 5px rgba(52, 152, 219, 0.1);
    }

    .music-player .player-btn:hover,
    .playlist-panel-wrap .player-btn:hover {
      background: linear-gradient(145deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(52, 152, 219, 0.25);
    }

    .music-player .player-progress {
      flex: 1;
      height: 6px;
      background: #ecf0f1;
      border-radius: 3px;
      margin: 0 10px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }

    .music-player .player-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      border-radius: 3px;
      transition: width 0.1s linear;
    }
    
    .music-player .player-progress:hover {
      height: 8px;
      transition: height 0.2s ease;
    }

    .music-player .player-time {
      font-size: 13px;
      color: #7f8c8d;
      min-width: 70px;
      text-align: right;
      font-family: monospace;
    }

    .music-player .player-volume {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .music-player .player-volume-bar {
      width: 70px;
      height: 4px;
      background: #ecf0f1;
      border-radius: 2px;
      position: relative;
      cursor: pointer;
      overflow: hidden;
    }

    .music-player .player-volume-level {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2980b9);
      border-radius: 2px;
      transition: width 0.2s;
    }
    
    .music-player .player-volume-bar:hover {
      height: 6px;
      transition: height 0.2s ease;
    }

    /* 新增播放列表样式 */
    .playlist-panel-wrap {
      width: 100%;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(52, 152, 219, 0.1);
      margin: 0 auto;
      overflow: hidden;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .playlist-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px 18px;
      border-bottom: 1px solid #ecf0f1;
    }

    .playlist-btn {
      background: none;
      border: none;
      color: #95a5a6;
      cursor: pointer;
      font-size: 13px;
      padding: 5px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .playlist-btn:hover {
      background: #f5f5f5;
      color: #e74c3c;
    }
    
    .playlist-btn svg {
      width: 14px;
      height: 14px;
    }

    .playlist-panel {
      margin-top: 0;
      padding: 8px 18px;
      overflow-y: auto;
      flex-grow: 1;
    }
    
    .playlist-panel::-webkit-scrollbar {
      width: 6px;
    }
    
    .playlist-panel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .playlist-panel::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 3px;
    }
    
    .playlist-panel::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }

    .playlist-item {
      padding: 12px 15px;
      font-size: 15px;
      color: #333;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      margin-bottom: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .playlist-item-delete {
      opacity: 0;
      margin-left: 8px;
      cursor: pointer;
      color: #bdc3c7;
      font-size: 16px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    
    .playlist-item:hover .playlist-item-delete {
      opacity: 1;
    }
    
    .playlist-item-delete:hover {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }

    .playlist-item.active {
      background: #eaf3ff;
      color: #3498db;
      font-weight: 700;
    }
    
    .playlist-item.active::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: #3498db;
      border-radius: 0 2px 2px 0;
    }

    .playlist-item:hover {
      background: #f5f9ff;
      transform: translateX(4px);
    }

    .playlist-item .playlist-artist {
      color: #95a5a6;
      font-size: 13px;
      font-weight: 400;
      margin-left: auto;
    }

    /* 加载更多按钮样式 */
    .load-more-btn {
      display: flex;
      margin: 20px auto;
      padding: 12px 30px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .load-more-btn:hover {
      background: #217dbb;
    }

    .load-more-btn:active {
      transform: scale(0.98);
    }

    .load-more-btn .loading-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    .load-more-btn.loading .loading-spinner {
      display: inline-block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 滚动加载指示器 */
    .scroll-loader {
      text-align: center;
      padding: 15px;
      display: none;
    }

    .scroll-loader::after {
      content: "加载中...";
      animation: dots 1.5s steps(5, end) infinite;
    }

    /* Cookie设置对话框样式 */
    .cookie-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .cookie-modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .cookie-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .cookie-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .cookie-textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 20px;
      font-family: monospace;
      resize: vertical;
    }

    .cookie-result {
      margin-top: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      word-break: break-all;
      display: none;
    }

    .cookie-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* 设置按钮样式 */
    .settings-btn {
      padding: 5px 10px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .settings-btn:hover {
      background-color: #e0e0e0;
    }

    .settings-icon {
      font-size: 16px;
    }

    /* 按钮组样式 */
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* 修改分隔条样式 */
    .resizer {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 10px;
      background-color: transparent;
      cursor: col-resize;
      z-index: 1500;
      transition: background-color 0.2s;
      right: 500px; /* 默认位置在播放器左侧 */
    }

    .resizer:hover, .resizer.active {
      background-color: rgba(52, 152, 219, 0.2);
    }

    .resizer-tip {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-90deg);
      color: #3498db;
      font-size: 13px;
      opacity: 0.5;
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
    }

    .resizer:hover .resizer-tip, .resizer.active .resizer-tip {
      opacity: 1;
      color: #1766a3;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>HiFiNi Music List</h1>
      <div class="header-actions">
        <div class="controls">
          <button class="btn" id="refreshBtn">获取新数据</button>
        </div>
        <button class="settings-btn" id="cookieSettingsBtn">
          <span class="settings-icon">⚙️</span>设置Cookie
        </button>
      </div>
      <div class="status" id="status"></div>
    </header>

    <div class="loading"></div>
    <div class="error"></div>
    <div class="music-list" id="musicList"></div>
    <div class="scroll-loader" id="scrollLoader"></div>

    <!-- 添加结果容器 -->
    <div id="resultContainer" style="display:none;">
      <div id="resultContent"></div>
    </div>
  </div>

  <!-- 分隔条 -->
  <div class="resizer" id="resizer"><span class="resizer-tip">⇆ 拖动调整宽度</span></div>

  <!-- 固定右侧播放器 -->
  <div class="player-container" id="playerContainer">
    <div class="music-player" id="musicPlayer"></div>
    <div class="playlist-panel-wrap" id="playlistPanel"></div>
  </div>

  <!-- Cookie设置对话框 -->
  <div class="cookie-modal" id="cookieModal">
    <div class="cookie-modal-content">
      <div class="cookie-modal-header">
        <h3>设置Cookie</h3>
        <button class="cookie-modal-close" id="closeCookieModal">&times;</button>
      </div>
      <div id="cookieInfo"></div>
      <p>请粘贴Hifini的Cookie JSON数据:</p>
      <textarea class="cookie-textarea" id="cookieInput"
        placeholder='[{"domain": "www.hifini.com", "name": "bbs_sid", "value": "xxx"}, ...]'></textarea>
      <div class="cookie-result" id="cookieResult"></div>
      <div class="cookie-actions">
        <button class="btn" id="parseCookieBtn">解析Cookie</button>
        <button class="btn" id="saveCookieBtn">保存到服务器</button>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let allMusicData = [];
    let currentMusicInfo = null;
    let playList = [];
    let playIndex = -1;
    let playMode = 'order'; // 'order' or 'random'
    let isLoadingMore = false; // 是否正在加载更多数据
    let hasMoreData = true; // 是否还有更多数据
    // 设置需要排除的线程ID列表
    const excludedThreadIds = ['6', '1575', '16216'];

    // Base32 编码函数
    function base32Encode(str) {
      var base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
      var bits = "";
      var base32 = "";

      for (var i = 0; i < str.length; i++) {
        var bit = str.charCodeAt(i).toString(2);
        while (bit.length < 8) {
          bit = "0" + bit;
        }
        bits += bit;
      }

      while (bits.length % 5 !== 0) {
        bits += "0";
      }

      for (var i = 0; i < bits.length; i += 5) {
        var chunk = bits.substring(i, i + 5);
        base32 += base32chars[parseInt(chunk, 2)];
      }

      while (base32.length % 8 !== 0) {
        base32 += "=";
      }

      return base32.replace(/=/g, 'HiFiNiYINYUECICHANG');
    }

    // 网页上的 generateParam 函数
    function generateParam(data) {
      var key = '95wwwHiFiNicom27';
      var outText = '';

      for (var i = 0, j = 0; i < data.length; i++, j++) {
        if (j == key.length) j = 0;
        outText += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(j));
      }
      return base32Encode(outText);
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    function displayMusicList(data, append = false, isNewData = false) {
      const musicList = document.getElementById('musicList');

      if (!append) {
        musicList.innerHTML = '';
      }

      // 计算需要多少列（从上到下、从左到右排列）
      const numRows = 10;
      const numCols = Math.ceil(data.length / numRows);

      // 创建一个二维数组用于重排数据
      let reorderedData = [];
      for (let col = 0; col < numCols; col++) {
        for (let row = 0; row < numRows; row++) {
          const index = col * numRows + row;
          if (index < data.length) {
            reorderedData.push(data[index]);
          }
        }
      }

      reorderedData.forEach(item => {
        const musicInfo = parseMusicInfo(item.title);
        const musicItem = document.createElement('div');
        musicItem.className = 'music-item';
        // 如果是新加载的数据，添加新数据样式
        if (isNewData) {
          musicItem.classList.add('new-item');
        }
        
        // 创建基本信息展示
        musicItem.innerHTML = `
          <div class="music-title">${musicInfo.title}</div>
          <div class="music-author">${musicInfo.artist}</div>
          <div class="music-item-action music-item-play">
            <span class="music-item-icon">▶️</span>
          </div>
          <div class="music-item-action music-item-add">
            <span class="music-item-icon">+</span>
          </div>
        `;
        
        // 移除整体点击事件，改为左右两侧单独点击事件
        const playAction = musicItem.querySelector('.music-item-play');
        const addAction = musicItem.querySelector('.music-item-add');
        
        // 立即播放
        playAction.onclick = (e) => {
          e.stopPropagation(); // 阻止冒泡
          item.parsedTitle = musicInfo.title;
          item.parsedArtist = musicInfo.artist;
          
          // 添加到播放列表的第一行并立即播放
          playList = playList.filter(s => s.threadId !== item.threadId); // 移除可能存在的相同歌曲
          playList.unshift({  // 使用unshift添加到列表开头
            ...item,
            musicInfo: musicInfo
          });
          playIndex = 0;  // 设置为第一首歌曲
          fetchThreadContentAndPlay(playList[playIndex]);
        };
        
        // 仅添加到播放列表
        addAction.onclick = (e) => {
          e.stopPropagation(); // 阻止冒泡
          item.parsedTitle = musicInfo.title;
          item.parsedArtist = musicInfo.artist;
          
          // 加入播放列表
          addToPlayList({
            ...item,
            musicInfo: musicInfo
          });
        };
        
        musicList.appendChild(musicItem);
      });
    }

    function updatePagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => goToPage(i);
        pagination.appendChild(pageBtn);
      }
    }

    function goToPage(page) {
      currentPage = page;
      const start = (page - 1) * 20;
      const end = start + 20;
      displayMusicList(allMusicData.slice(start, end));
      updatePagination();
    }

    // 解析音乐标题和歌手
    function parseMusicInfo(title) {
      // 只取第一个《》里的内容为title，前面为artist，后面忽略
      const match = title.match(/^(.*?)《([^》]+)》/);
      if (match) {
        return {
          artist: match[1].replace(/\[.*?\]/g, '').trim(),
          title: match[2].trim()
        };
      }
      return {
        artist: '',
        title: title.trim()
      };
    }

    // 显示音乐详情的函数
    function displayMusicDetail(detail) {
      let musicUrl = detail.musicUrl;
      // 新增：如果rawKey以.m4a结尾，fetch并带headers
      if (detail.rawKey && typeof detail.rawKey === 'string' && detail.rawKey.endsWith('.m4a')) {
        // 获取播放器容器
        const playerContainer = document.getElementById('playerContainer');
        const musicPlayer = document.getElementById('musicPlayer');
        const playlistPanel = document.getElementById('playlistPanel');
        playerContainer.style.display = 'flex';
        if (musicPlayer.audio) musicPlayer.audio.pause();
        
        // 提前保存封面图片URL (优先使用服务器返回的coverImage)
        const coverImageUrl = detail.coverImage || 'https://lixingyu.cn/star.ico';
        
        // 显示加载中，同时显示封面
        musicPlayer.innerHTML = `
        <div class="player-header-draggable">
          <img src="${coverImageUrl}" class="player-cover"/>
          <div class="player-info">
            <div class="player-title">${currentMusicInfo?.title || '加载中...'}</div>
            <div class="player-author">${currentMusicInfo?.artist || '正在获取音频...'}</div>
          </div>
        </div>
        <div style='text-align:center;padding:20px;color:#3498db;'>
          <div>音频加载中...</div>
        </div>`;
        
        // 通过后端代理请求音频
        const proxyUrl = `/api/proxyAudio?url=${encodeURIComponent(detail.rawKey)}`;
        console.log('代理请求m4a音频:', detail.rawKey);
        
        fetch(proxyUrl, {
          method: 'GET'
        })
        .then(response => {
          if (!response.ok) throw new Error('音频获取失败: ' + response.status);
          return response.blob();
        })
        .then(blob => {
          console.log('音频获取成功, 大小:', Math.round(blob.size / 1024), 'KB');
          const audioUrl = URL.createObjectURL(blob);
          const audio = new Audio(audioUrl);
          musicPlayer.audio = audio;
          
          const showTitle = (currentMusicInfo && currentMusicInfo.title) ? currentMusicInfo.title : '';
          const showArtist = (currentMusicInfo && currentMusicInfo.artist) ? currentMusicInfo.artist : '';
          
          musicPlayer.innerHTML = `
            <div class="player-header-draggable">
              <img src="${coverImageUrl}" class="player-cover"/>
              <div class="player-info">
                <div class="player-title">${showTitle}</div>
                <div class="player-author">${showArtist}</div>
              </div>
            </div>
            <div class="player-controls">
              <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
              <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
              <div class="player-time">0:00 / 0:00</div>
              <div class="player-volume">
                <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${svgVolume}</span></button>
                <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:100%"></div></div>
              </div>
            </div>
          `;
          const playBtn = musicPlayer.querySelector('.player-btn.play');
          const playIcon = playBtn.querySelector('.play-icon');
          const progressBar = musicPlayer.querySelector('.player-progress-bar');
          const timeDisplay = musicPlayer.querySelector('.player-time');
          const volumeBar = musicPlayer.querySelector('.player-volume-level');
          audio.addEventListener('play', () => { playIcon.innerHTML = svgPause; });
          audio.addEventListener('pause', () => { playIcon.innerHTML = svgPlay; });
          audio.addEventListener('timeupdate', () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = `${progress}%`;
            timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
          });
          audio.addEventListener('volumechange', () => {
            volumeBar.style.width = `${audio.volume * 100}%`;
          });
          audio.addEventListener('ended', () => {
            playNext({ stopPropagation: () => { } });
          });
          audio.play().catch((e) => { 
            console.error('音频播放失败:', e);
          });
          setTimeout(() => {
            renderPlayList();
          }, 100);
        })
        .catch(err => {
          console.error('音频加载失败:', err);
          musicPlayer.innerHTML = `
          <div class="player-header-draggable">
            <img src="${coverImageUrl}" class="player-cover"/>
            <div class="player-info">
              <div class="player-title">${currentMusicInfo?.title || '加载失败'}</div>
              <div class="player-author">${currentMusicInfo?.artist || '无法播放'}</div>
            </div>
          </div>
          <div style='color:red;padding:20px;text-align:center;'>
            <div>音频加载失败: ${err.message}</div>
            <button onclick="fetchThreadContentAndPlay(playList[playIndex])" 
              style="margin-top:10px;padding:5px 10px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer">
              重试
            </button>
          </div>`;
        });
        return;
      }
      if (detail.rawKey && detail.generateParamString) {
        const newP = generateParam(detail.generateParamString);
        musicUrl += `?key=${detail.rawKey}&p=${newP}`;
        const audio = new Audio(musicUrl);
        
        // 获取固定的播放器容器
        const playerContainer = document.getElementById('playerContainer');
        const musicPlayer = document.getElementById('musicPlayer');
        const playlistPanel = document.getElementById('playlistPanel');
        
        // 显示播放器容器
        playerContainer.style.display = 'flex';
        
        if (musicPlayer.audio) musicPlayer.audio.pause();
        musicPlayer.audio = audio;
        
        const showTitle = (currentMusicInfo && currentMusicInfo.title) ? currentMusicInfo.title : '';
        const showArtist = (currentMusicInfo && currentMusicInfo.artist) ? currentMusicInfo.artist : '';
        
        musicPlayer.innerHTML = `
          <div class="player-header-draggable">
            <img src="${detail.coverImage || 'https://lixingyu.cn/star.ico'}" class="player-cover"/>
            <div class="player-info">
              <div class="player-title">${showTitle}</div>
              <div class="player-author">${showArtist}</div>
            </div>
          </div>
          <div class="player-controls">
            <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
            <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
            <div class="player-time">0:00 / 0:00</div>
            <div class="player-volume">
              <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${svgVolume}</span></button>
              <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:100%"></div></div>
            </div>
          </div>
        `;

        const playBtn = musicPlayer.querySelector('.player-btn.play');
        const playIcon = playBtn.querySelector('.play-icon');
        const progressBar = musicPlayer.querySelector('.player-progress-bar');
        const timeDisplay = musicPlayer.querySelector('.player-time');
        const volumeBar = musicPlayer.querySelector('.player-volume-level');
        
        audio.addEventListener('play', () => { playIcon.innerHTML = svgPause; });
        audio.addEventListener('pause', () => { playIcon.innerHTML = svgPlay; });
        audio.addEventListener('timeupdate', () => {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = `${progress}%`;
          timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        });
        audio.addEventListener('volumechange', () => {
          volumeBar.style.width = `${audio.volume * 100}%`;
        });
        // 自动播放下一首
        audio.addEventListener('ended', () => {
          playNext({ stopPropagation: () => { } });
        });
        
        audio.play().catch(() => { });
        setTimeout(() => {
          renderPlayList();
        }, 100);
      } else {
        const resultContent = document.getElementById('resultContent');
        if (resultContent) {
          resultContent.innerHTML = `
            <div class="music-player">
              <div class="player-header">
                <div class="player-info">
                  <div class="player-title">${detail.title}</div>
                  <div class="player-author">${detail.author || '未知作者'}</div>
                </div>
              </div>
              ${detail.lyrics ? `
                <div class="lyrics-container">
                  ${detail.lyrics.split('\n').map(line => `
                    <div class="lyrics-line">${line}</div>
                  `).join('')}
                </div>
              ` : ''}
              <div style="margin-top: 20px;">
                <strong>下载链接:</strong><br>
                ${detail.downloadLinks.map(link => `
                  <a href="${link}" target="_blank" style="color: #3498db; text-decoration: none;">${link}</a><br>
                `).join('')}
              </div>
            </div>
          `;
          document.getElementById('resultContainer').style.display = 'block';
        }
      }
    }

    // 移除不需要的浮动播放器函数
    function closeFloatingPlayer(e) {
      const musicPlayer = document.getElementById('musicPlayer');
      if (musicPlayer && musicPlayer.audio) musicPlayer.audio.pause();
      document.getElementById('playerContainer').style.display = 'none';
    }

    // 不再需要点击空白处关闭播放器
    function floatingPlayerClickAway(e) {
      // 此函数保留但不再使用
    }

    // 播放控制函数
    function togglePlay(button) {
      const player = document.querySelector('.music-player');
      const audio = player.audio;
      const icon = button.querySelector('.play-icon');

      if (audio.paused) {
        audio.play();
        icon.innerHTML = svgPause;
      } else {
        audio.pause();
        icon.innerHTML = svgPlay;
      }
    }

    function seek(event) {
      const player = document.querySelector('.music-player');
      const audio = player.audio;
      const progressBar = event.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const percentage = x / rect.width;
      audio.currentTime = audio.duration * percentage;
    }

    function toggleMute(button) {
      const player = document.querySelector('.music-player');
      const audio = player.audio;
      const icon = button.querySelector('.volume-icon');

      if (audio.muted) {
        audio.muted = false;
        icon.innerHTML = svgVolume;
      } else {
        audio.muted = true;
        icon.innerHTML = svgMute;
      }
    }

    function setVolume(event) {
      const player = document.querySelector('.music-player');
      const audio = player.audio;
      const volumeBar = event.currentTarget;
      const rect = volumeBar.getBoundingClientRect();
      const x = event.clientX - rect.left;
      audio.volume = x / rect.width;
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      seconds = Math.floor(seconds % 60);
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // 获取线程内容的函数
    async function fetchThreadContent(threadId) {
      try {
        updateStatus(`正在获取线程 ${threadId} 的内容...`);

        const response = await fetch(`/music/${threadId}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const detail = await response.json();
        displayMusicDetail(detail);
        updateStatus(`已获取线程 ${threadId} 的内容`);
      } catch (error) {
        console.error('Error fetching thread content:', error);
        updateStatus(`获取线程 ${threadId} 失败: ${error.message}`);

        const resultContent = document.getElementById('resultContent');
        resultContent.innerHTML = `<span style="color: red;">获取失败: ${error.message}</span>`;
        document.getElementById('resultContainer').style.display = 'block';
      }
    }

    async function fetchPage(page) {
      const response = await fetch(`/api/songs?page=${page}`);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return await response.json();
    }

    // 新增：全局去重函数
    function removeDuplicates(array, idField = 'threadId') {
      const seen = new Set();
      return array.filter(item => {
        const id = item[idField];
        if (seen.has(id)) {
          return false;
        }
        seen.add(id);
        return true;
      });
    }

    // 过滤掉排除的线程ID
    function filterExcludedThreads(data) {
      return data.filter(item => !excludedThreadIds.includes(item.threadId));
    }

    // 获取已加载歌曲的ID集合
    function getExistingIds() {
      return new Set(allMusicData.map(item => item.threadId));
    }

    // 检查Cookie状态的函数
    async function checkCookieStatus() {
      try {
        const response = await fetch('/api/cookieStatus');
        if (!response.ok) {
          throw new Error('获取Cookie状态失败');
        }

        const status = await response.json();

        if (status.needsUpdate) {
          // 显示Cookie设置对话框
          showCookieModal(true);
          updateStatus('您的Cookie已过期或未设置，请更新Cookie');
          return false;
        }

        return true;
      } catch (error) {
        console.error('检查Cookie状态出错:', error);
        updateStatus('检查Cookie状态出错: ' + error.message);
        return false;
      }
    }

    // 显示或隐藏Cookie设置对话框
    function showCookieModal(forced = false) {
      const cookieModal = document.getElementById('cookieModal');
      cookieModal.style.display = 'flex';

      // 如果是强制更新，添加提示信息
      if (forced) {
        const cookieInfoEl = document.getElementById('cookieInfo');
        if (cookieInfoEl) {
          cookieInfoEl.innerHTML = '<div style="color: #e74c3c; margin-bottom: 10px; font-weight: bold;">⚠️ Cookie已过期或未设置，请更新后才能继续使用</div>';
        }

        // 禁用关闭按钮
        const closeBtn = document.getElementById('closeCookieModal');
        if (closeBtn) {
          closeBtn.style.display = 'none';
        }

        // 阻止点击外部关闭
        cookieModal.dataset.forced = 'true';
      } else {
        // 恢复关闭按钮
        const closeBtn = document.getElementById('closeCookieModal');
        if (closeBtn) {
          closeBtn.style.display = 'block';
        }

        // 允许正常关闭
        cookieModal.dataset.forced = 'false';

        // 清除提示信息
        const cookieInfoEl = document.getElementById('cookieInfo');
        if (cookieInfoEl) {
          cookieInfoEl.innerHTML = '';
        }
      }
    }

    async function loadMoreData() {
      if (isLoadingMore || !hasMoreData) return;

      // 检查Cookie状态
      const cookieValid = await checkCookieStatus();
      if (!cookieValid) {
        return; // 如果Cookie无效，停止加载
      }

      isLoadingMore = true;
      const scrollLoader = document.getElementById('scrollLoader');
      scrollLoader.style.display = 'block';

      try {
        updateStatus(`正在加载更多歌曲...`);
        const pageData = await fetchPage(currentPage);

        // 过滤掉排除的线程ID
        const filteredData = filterExcludedThreads(pageData);

        // 过滤重复数据
        const existingIds = getExistingIds();
        const newData = filteredData.filter(item => !existingIds.has(item.threadId));

        if (newData.length === 0) {
          hasMoreData = false;
          updateStatus(`没有更多歌曲了`);
          scrollLoader.style.display = 'none';
          return;
        }

        // 合并去重后的数据
        allMusicData = [...allMusicData, ...newData];
        displayMusicList(newData, true);
        currentPage++;

        updateStatus(`已加载 ${allMusicData.length} 首歌曲`);
      } catch (err) {
        const error = document.querySelector('.error');
        error.textContent = '加载失败: ' + err.message;
        error.style.display = 'block';
        hasMoreData = false; // 出错时停止加载
      } finally {
        isLoadingMore = false;
        scrollLoader.style.display = 'none';
      }
    }

    // 添加滚动事件监听
    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (isLoadingMore || !hasMoreData) return;

        const scrollY = window.scrollY;
        const visibleHeight = window.innerHeight;
        const pageHeight = document.documentElement.scrollHeight;
        const bottomOfPage = visibleHeight + scrollY >= pageHeight - 300;

        if (bottomOfPage) {
          loadMoreData();
        }
      });
    }

    // 新增：加入播放列表
    function addToPlayList(song) {
      // 检查是否已在播放列表中（可根据 threadId 唯一性）
      const exists = playList.findIndex(s => s.threadId === song.threadId);
      if (exists === -1) {
        // 新歌插入到当前播放歌曲后面
        if (playIndex >= 0 && playIndex < playList.length - 1) {
          playList.splice(playIndex + 1, 0, song);
        } else {
          playList.push(song);
        }
      }
      // 如果没有正在播放，则立即播放
      if (playIndex === -1) {
        playIndex = playList.length - 1;
        fetchThreadContentAndPlay(playList[playIndex]);
      }
      renderPlayList();
    }

    // 修改渲染播放列表函数
    function renderPlayList() {
      const playlistPanel = document.getElementById('playlistPanel');
      if (!playlistPanel) return;
      
      // 先渲染控制按钮
      let listHtml = `<div class="playlist-controls">`;
      listHtml += `<button class='player-btn mode-btn' onclick='togglePlayMode(event)' title='顺序/随机' style='font-size:16px;'>${playMode === 'order' ? svgOrder : svgShuffle}</button>`;
      listHtml += `<button class='player-btn prev-btn' onclick='playPrev(event)' title='上一首' style='font-size:16px;'>${svgPrev}</button>`;
      listHtml += `<button class='player-btn next-btn' onclick='playNext(event)' title='下一首' style='font-size:16px;'>${svgNext}</button>`;
      
      // 添加清空列表按钮
      if (playList.length > 1) {
        listHtml += `<button class='playlist-btn' onclick='clearPlayList(event)' title='清空播放列表'>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          清空列表
        </button>`;
      }
      
      listHtml += `<div style="margin-left:auto;font-size:14px;color:#7f8c8d;">${playList.length} 首歌曲</div>`;
      listHtml += `</div>`;

      // 再渲染播放列表
      listHtml += '<div class="playlist-panel">';
      if (playList.length === 0) {
        listHtml += `<div style="text-align:center;padding:20px;color:#95a5a6;font-size:14px;">播放列表为空<br>点击歌曲卡片上的 + 添加歌曲</div>`;
      } else {
        playList.forEach((song, idx) => {
          const isCurrentPlaying = idx === playIndex;
          listHtml += `<div class="playlist-item${isCurrentPlaying ? ' active' : ''}" onclick="playFromList(${idx})">
            <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;">${song.musicInfo.title}</span>
            <span class='playlist-artist'>${song.musicInfo.artist}</span>
            ${!isCurrentPlaying ? 
              `<span class="playlist-item-delete" onclick="removeFromPlayList(${idx}, event)" title="从列表中移除">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </span>` 
            : ''}
          </div>`;
        });
      }
      listHtml += '</div>';

      playlistPanel.innerHTML = listHtml;
    }

    // 新增：切换播放模式
    function togglePlayMode(e) {
      e.stopPropagation();
      playMode = playMode === 'order' ? 'random' : 'order';
      renderPlayList();
    }
    // 新增：播放上一首
    function playPrev(e) {
      e.stopPropagation();
      if (playList.length === 0) return;
      if (playMode === 'random') {
        let idx;
        do { idx = Math.floor(Math.random() * playList.length); } while (idx === playIndex && playList.length > 1);
        playIndex = idx;
      } else {
        playIndex = (playIndex - 1 + playList.length) % playList.length;
      }
      fetchThreadContentAndPlay(playList[playIndex]);
    }
    // 新增：播放下一首
    function playNext(e) {
      e.stopPropagation();
      if (playList.length === 0) return;
      if (playMode === 'random') {
        let idx;
        do { idx = Math.floor(Math.random() * playList.length); } while (idx === playIndex && playList.length > 1);
        playIndex = idx;
      } else {
        playIndex = (playIndex + 1) % playList.length;
      }
      fetchThreadContentAndPlay(playList[playIndex]);
    }
    // 新增：点击播放列表切歌
    function playFromList(idx) {
      playIndex = idx;
      fetchThreadContentAndPlay(playList[playIndex]);
    }
    // 新增：根据song对象获取详情并播放
    function fetchThreadContentAndPlay(song) {
      currentMusicInfo = song.musicInfo;
      fetch(`/music/${song.threadId}`)
        .then(res => res.json())
        .then(detail => displayMusicDetail(detail));
    }

    // 播放/暂停键控制
    function setupSpacebarControl() {
      document.addEventListener('keydown', (e) => {
        // 32 是空格键的 keyCode
        if (e.keyCode === 32 || e.key === ' ') {
          // 查找当前是否有活动的输入框
          const activeElement = document.activeElement;
          const isInputActive = activeElement && (
            activeElement.tagName === 'INPUT' ||
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.isContentEditable
          );

          // 如果不是在输入框中，则控制播放/暂停
          if (!isInputActive) {
            e.preventDefault(); // 阻止默认行为（滚动页面）

            const player = document.querySelector('.music-player');
            if (player && player.audio) {
              if (player.audio.paused) {
                player.audio.play();
                player.querySelector('.play-icon').innerHTML = svgPause;
                // 显示提示
                showTemporaryMessage('播放 (空格键)');
              } else {
                player.audio.pause();
                player.querySelector('.play-icon').innerHTML = svgPlay;
                // 显示提示
                showTemporaryMessage('暂停 (空格键)');
              }
            }
          }
        }
      });
    }

    // 添加临时消息提示
    function showTemporaryMessage(message) {
      // 创建或获取消息元素
      let msgElem = document.getElementById('temp-message');
      if (!msgElem) {
        msgElem = document.createElement('div');
        msgElem.id = 'temp-message';
        msgElem.style.position = 'fixed';
        msgElem.style.top = '20px';
        msgElem.style.left = '50%';
        msgElem.style.transform = 'translateX(-50%)';
        msgElem.style.padding = '8px 16px';
        msgElem.style.background = 'rgba(0,0,0,0.7)';
        msgElem.style.color = 'white';
        msgElem.style.borderRadius = '4px';
        msgElem.style.zIndex = '9999';
        msgElem.style.opacity = '0';
        msgElem.style.transition = 'opacity 0.3s ease';
        document.body.appendChild(msgElem);
      }
      
      // 设置消息并显示
      msgElem.textContent = message;
      msgElem.style.opacity = '1';
      
      // 显示提示的实际播放状态
      const player = document.querySelector('.music-player');
      if (player && player.audio) {
        if (message === '播放 (空格键)' && player.audio.paused) {
          msgElem.textContent = '播放失败，请点击播放按钮重试';
        }
        if (message === '暂停 (空格键)' && !player.audio.paused) {
          msgElem.textContent = '暂停失败，请点击暂停按钮重试';
        }
      }
      
      // 2秒后淡出
      setTimeout(() => {
        msgElem.style.opacity = '0';
      }, 2000);
    }

    // 页面加载完成后设置空格键控制
    document.addEventListener('DOMContentLoaded', () => {
      setupSpacebarControl();
      initializeApp();
    });

    // 刷新首页数据
    async function refreshFirstPage() {
      if (isLoadingMore) return;

      // 先检查Cookie状态
      const cookieValid = await checkCookieStatus();
      if (!cookieValid) {
        return; // 如果Cookie无效，停止刷新
      }

      isLoadingMore = true;
      const loading = document.querySelector('.loading');
      const error = document.querySelector('.error');
      const refreshBtn = document.getElementById('refreshBtn');

      loading.style.display = 'block';
      error.style.display = 'none';
      refreshBtn.disabled = true;

      try {
        updateStatus(`正在获取新歌曲数据...`);
        const pageData = await fetchPage(1); // 始终获取第一页

        // 过滤掉排除的线程ID
        const filteredData = filterExcludedThreads(pageData);

        // 记录当前数据的IDs以便对比
        const existingIds = getExistingIds();

        // 过滤出新数据
        const newData = filteredData.filter(item => !existingIds.has(item.threadId));

        if (newData.length === 0) {
          updateStatus(`没有发现新的歌曲数据`);
        } else {
          // 将新数据添加到现有数据的开头
          allMusicData = [...newData, ...allMusicData];

          // 先移除所有之前的新歌标记
          document.querySelectorAll('.music-item.new-item').forEach(item => {
            item.classList.remove('new-item');
          });

          // 在当前列表前面添加新歌曲
          const musicList = document.getElementById('musicList');
          const numRows = 10;
          const numCols = Math.ceil(newData.length / numRows);

          // 创建一个二维数组用于重排数据
          let reorderedNewData = [];
          for (let col = 0; col < numCols; col++) {
            for (let row = 0; row < numRows; row++) {
              const index = col * numRows + row;
              if (index < newData.length) {
                reorderedNewData.push(newData[index]);
              }
            }
          }

          // 创建临时容器以保存新项目
          const tempContainer = document.createDocumentFragment();
          
          // 添加新歌曲到临时容器
          reorderedNewData.forEach(item => {
            const musicInfo = parseMusicInfo(item.title);
            const musicItem = document.createElement('div');
            musicItem.className = 'music-item new-item'; // 添加new-item类标记为新数据
            
            // 创建基本信息展示
            musicItem.innerHTML = `
              <div class="music-title">${musicInfo.title}</div>
              <div class="music-author">${musicInfo.artist}</div>
              <div class="music-item-action music-item-play">
                <span class="music-item-icon">▶️</span>
              </div>
              <div class="music-item-action music-item-add">
                <span class="music-item-icon">+</span>
              </div>
            `;
            
            // 添加点击事件
            const playAction = musicItem.querySelector('.music-item-play');
            const addAction = musicItem.querySelector('.music-item-add');
            
            // 立即播放
            playAction.onclick = (e) => {
              e.stopPropagation(); // 阻止冒泡
              item.parsedTitle = musicInfo.title;
              item.parsedArtist = musicInfo.artist;
              
              // 添加到播放列表的第一行并立即播放
              playList = playList.filter(s => s.threadId !== item.threadId); // 移除可能存在的相同歌曲
              playList.unshift({  // 使用unshift添加到列表开头
                ...item,
                musicInfo: musicInfo
              });
              playIndex = 0;  // 设置为第一首歌曲
              fetchThreadContentAndPlay(playList[playIndex]);
            };
            
            // 仅添加到播放列表
            addAction.onclick = (e) => {
              e.stopPropagation(); // 阻止冒泡
              item.parsedTitle = musicInfo.title;
              item.parsedArtist = musicInfo.artist;
              
              // 加入播放列表
              addToPlayList({
                ...item,
                musicInfo: musicInfo
              });
            };
            
            tempContainer.appendChild(musicItem);
          });
          
          // 将新的歌曲项插入到列表的开头
          if (musicList.firstChild) {
            musicList.insertBefore(tempContainer, musicList.firstChild);
          } else {
            musicList.appendChild(tempContainer);
          }

          updateStatus(`已添加 ${newData.length} 首新歌曲，总计 ${allMusicData.length} 首歌曲`);

          // 确保可以继续无限滚动
          hasMoreData = true;
        }
      } catch (err) {
        error.textContent = '获取新数据失败: ' + err.message;
        error.style.display = 'block';
      } finally {
        isLoadingMore = false;
        loading.style.display = 'none';
        refreshBtn.disabled = false;
      }
    }

    // Cookie处理函数
    function setupCookieModal() {
      const cookieSettingsBtn = document.getElementById('cookieSettingsBtn');
      const cookieModal = document.getElementById('cookieModal');
      const closeCookieModal = document.getElementById('closeCookieModal');
      const cookieInput = document.getElementById('cookieInput');
      const cookieResult = document.getElementById('cookieResult');
      const parseCookieBtn = document.getElementById('parseCookieBtn');
      const saveCookieBtn = document.getElementById('saveCookieBtn');

      // 打开对话框
      cookieSettingsBtn.addEventListener('click', () => {
        showCookieModal(false);
      });

      // 关闭对话框
      closeCookieModal.addEventListener('click', () => {
        cookieModal.style.display = 'none';
      });

      // 点击对话框外部关闭
      window.addEventListener('click', (e) => {
        if (e.target === cookieModal && cookieModal.dataset.forced !== 'true') {
          cookieModal.style.display = 'none';
        }
      });

      // 解析Cookie
      parseCookieBtn.addEventListener('click', () => {
        try {
          const cookieJson = cookieInput.value.trim();
          let cookieArray;

          try {
            cookieArray = JSON.parse(cookieJson);
          } catch (e) {
            throw new Error('Cookie JSON格式不正确，请检查输入');
          }

          if (!Array.isArray(cookieArray)) {
            throw new Error('Cookie格式必须是数组');
          }

          // 构建Cookie字符串
          const cookieStr = cookieArray
            .filter(cookie => cookie.name && cookie.value)
            .map(cookie => `${cookie.name}=${cookie.value}`)
            .join('; ');

          // 显示结果
          cookieResult.style.display = 'block';
          cookieResult.textContent = cookieStr;

          // 启用保存按钮
          saveCookieBtn.disabled = false;
        } catch (error) {
          cookieResult.style.display = 'block';
          cookieResult.textContent = `错误: ${error.message}`;
          saveCookieBtn.disabled = true;
        }
      });

      // 保存Cookie到服务器
      saveCookieBtn.addEventListener('click', async () => {
        const cookieStr = cookieResult.textContent;
        if (!cookieStr || saveCookieBtn.disabled) return;

        try {
          updateStatus('正在保存Cookie...');

          const response = await fetch('/api/setCookie', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cookie: cookieStr })
          });

          if (!response.ok) {
            throw new Error(`服务器响应错误: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            updateStatus('Cookie设置成功');
            cookieModal.style.display = 'none';

            // 刷新数据
            refreshFirstPage();
          } else {
            throw new Error(result.message || '保存失败');
          }
        } catch (error) {
          updateStatus(`Cookie设置失败: ${error.message}`);
        }
      });
    }

    // 修改初始化函数，确保播放器始终可见
    async function initializeApp() {
      const loading = document.querySelector('.loading');
      loading.style.display = 'block';

      try {
        // 首先检查Cookie状态
        const cookieValid = await checkCookieStatus();

        if (cookieValid) {
          await loadMoreData();
          setupInfiniteScroll();
        }

        // 添加刷新按钮事件监听
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.addEventListener('click', refreshFirstPage);

        // 设置Cookie对话框
        setupCookieModal();
        
        // 确保播放器容器可见，并设置默认内容
        const playerContainer = document.getElementById('playerContainer');
        const musicPlayer = document.getElementById('musicPlayer');
        playerContainer.style.display = 'flex';
        
        // 设置默认播放器内容
        musicPlayer.innerHTML = `
          <div class="player-header-draggable">
            <img src="https://lixingyu.cn/star.ico" class="player-cover"/>
            <div class="player-info">
              <div class="player-title">欢迎使用 HiFiNi Music</div>
              <div class="player-author">点击音乐开始播放 (空格键暂停/播放)</div>
            </div>
          </div>
          <div class="player-controls">
            <button class="player-btn play" onclick="togglePlay(this)"><span class="play-icon">${svgPlay}</span></button>
            <div class="player-progress" onclick="seek(event)"><div class="player-progress-bar" style="width:0%"></div></div>
            <div class="player-time">0:00 / 0:00</div>
            <div class="player-volume">
              <button class="player-btn" onclick="toggleMute(this)"><span class="volume-icon">${svgVolume}</span></button>
              <div class="player-volume-bar" onclick="setVolume(event)"><div class="player-volume-level" style="width:100%"></div></div>
            </div>
          </div>
        `;
        
        // 设置拖动调整宽度功能
        setupResizer();
      } finally {
        loading.style.display = 'none';
      }
    }

    // 更新分隔条位置
    function updateResizerPosition() {
      const playerContainer = document.getElementById('playerContainer');
      const resizer = document.getElementById('resizer');
      
      // 分隔条位置与播放器左边界对齐
      resizer.style.right = playerContainer.offsetWidth + 'px';
    }

    // 替换setupResizer函数中的移动处理逻辑
    function setupResizer() {
      const resizer = document.getElementById('resizer');
      const container = document.querySelector('.container');
      const playerContainer = document.getElementById('playerContainer');
      
      // 初始化分隔条位置
      updateResizerPosition();
      
      let isResizing = false;
      let lastX = 0;
      
      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        resizer.classList.add('active');
        lastX = e.clientX;
        
        // 防止选中文本
        document.body.style.userSelect = 'none';
        
        const onMouseMove = (e) => {
          if (!isResizing) return;
          
          // 计算移动距离
          const dx = e.clientX - lastX;
          lastX = e.clientX;
          
          // 获取当前宽度
          const currentPlayerWidth = playerContainer.offsetWidth;
          
          // 计算新的播放器宽度
          const minWidth = 300; // 最小宽度
          const maxWidth = window.innerWidth - 300; // 最大宽度（留出左侧最小空间）
          
          // 计算新的播放器宽度
          let newPlayerWidth = Math.min(maxWidth, Math.max(minWidth, currentPlayerWidth - dx));
          
          // 更新播放器宽度
          playerContainer.style.width = `${newPlayerWidth}px`;
          
          // 更新内容区宽度
          container.style.width = `calc(100% - ${newPlayerWidth}px)`;
          
          // 更新分隔条位置
          updateResizerPosition();
        };
        
        const onMouseUp = () => {
          isResizing = false;
          resizer.classList.remove('active');
          document.body.style.userSelect = '';
          
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
      
      // 窗口大小改变时更新分隔条位置
      window.addEventListener('resize', updateResizerPosition);
    }

    // 在脚本最前面定义SVG变量：
    const svgPlay = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 17,10 5,17" fill="#fff"/></svg>`;
    const svgPause = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="3" width="4" height="14" rx="1" fill="#fff"/><rect x="12" y="3" width="4" height="14" rx="1" fill="#fff"/></svg>`;
    const svgPrev = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="15,3 7,10 15,17" fill="#fff"/><rect x="4" y="3" width="2" height="14" rx="1" fill="#fff"/></svg>`;
    const svgNext = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="5,3 13,10 5,17" fill="#fff"/><rect x="14" y="3" width="2" height="14" rx="1" fill="#fff"/></svg>`;
    const svgVolume = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="3,8 7,8 12,4 12,16 7,12 3,12" fill="#fff"/></svg>`;
    const svgMute = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="3,8 7,8 12,4 12,16 7,12 3,12" fill="#fff"/><line x1="15" y1="7" x2="19" y2="13" stroke="#fff" stroke-width="2"/><line x1="19" y1="7" x2="15" y2="13" stroke="#fff" stroke-width="2"/></svg>`;
    const svgOrder = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="9" width="14" height="2" rx="1" fill="#fff"/></svg>`;
    const svgShuffle = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4L16 16M16 4L4 16" stroke="#fff" stroke-width="2"/></svg>`;

    // 删除播放列表中的单个歌曲
    function removeFromPlayList(index, e) {
      e.stopPropagation(); // 阻止冒泡，避免点击删除按钮时触发播放
      
      // 不允许删除当前播放的歌曲
      if (index === playIndex) {
        showTemporaryMessage('无法删除当前播放的歌曲');
        return;
      }
      
      // 如果删除的是当前播放歌曲之前的歌曲，需要调整playIndex
      if (index < playIndex) {
        playIndex--;
      }
      
      // 从播放列表中删除
      playList.splice(index, 1);
      
      // 重新渲染播放列表
      renderPlayList();
      showTemporaryMessage('已从播放列表移除');
    }
    
    // 清空播放列表（保留当前播放的歌曲）
    function clearPlayList(e) {
      e.stopPropagation();
      
      // 如果列表为空或只有一首歌
      if (playList.length <= 1) {
        showTemporaryMessage('播放列表已为空');
        return;
      }
      
      // 如果有当前播放的歌曲，保留它
      if (playIndex !== -1) {
        const currentSong = playList[playIndex];
        playList = [currentSong];
        playIndex = 0;
      } else {
        // 如果没有当前播放的歌曲，完全清空
        playList = [];
        playIndex = -1;
      }
      
      // 重新渲染播放列表
      renderPlayList();
      showTemporaryMessage('已清空播放列表(保留当前播放歌曲)');
    }
  </script>
</body>

</html>